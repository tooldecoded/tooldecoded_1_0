{% extends 'components_backoffice/base.html' %}

{% block content %}
<h2>Components (Editor)</h2>

<form method="get" style="margin-bottom: 1rem;">
  <input type="text" name="q" value="{{ q }}" placeholder="Search by name" />
  <button type="submit">Apply</button>
  {% if q %}<a href="?">Clear</a>{% endif %}
  <a href="{% url 'components_backoffice:component_create' %}" style="margin-left:1rem;">New Component</a>
  {% csrf_token %}
</form>

<table border="1" cellpadding="6" cellspacing="0">
  <thead>
    <tr>
      <th>Brand</th>
      <th>SKU</th>
      <th>Name (inline)</th>
      <th>Featured</th>
      <th>Standalone Price</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for c in page_obj.object_list %}
      <tr data-brand="{{ c.brand.name|slugify }}" data-sku="{{ c.sku }}">
        <td>{{ c.brand.name }}</td>
        <td>{{ c.sku }}</td>
        <td>
          <input type="text" value="{{ c.name }}" data-field="name" class="bo-inline" style="width: 240px;" />
        </td>
        <td>
          <input type="checkbox" {% if c.is_featured %}checked{% endif %} data-field="is_featured" class="bo-inline" />
        </td>
        <td>
          <input type="number" step="0.01" min="0" value="{{ c.standalone_price }}" data-field="standalone_price" class="bo-inline" style="width: 120px;" />
        </td>
        <td>
          <a href="{% url 'components_backoffice:component_detail' brand_slug=c.brand.name|slugify sku_or_nk=c.sku %}">Edit</a>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="6">No results</td></tr>
    {% endfor %}
  </tbody>
</table>

<div style="margin-top: 1rem;">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}&q={{ q }}">Previous</a>
  {% endif %}
  {% if page_obj.has_next %}
    <a style="margin-left: 1rem;" href="?page={{ page_obj.next_page_number }}&q={{ q }}">Next</a>
  {% endif %}
</div>

<script>
  (function() {
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrfToken = getCookie('csrftoken');

    function postInline(url, payload) {
      return fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken || ''
        },
        body: JSON.stringify(payload)
      }).then(r => r.json());
    }

    document.querySelectorAll('tr[data-brand][data-sku]').forEach(function(row) {
      const brand = row.getAttribute('data-brand');
      const sku = row.getAttribute('data-sku');
      const baseUrl = `/components-backoffice/editor/components/${brand}/${encodeURIComponent(sku)}/inline/`;

      row.querySelectorAll('.bo-inline').forEach(function(input) {
        const field = input.getAttribute('data-field');

        function send(value) {
          postInline(baseUrl, { field: field, value: value })
            .then(function(resp) {
              if (resp && resp.error) {
                alert('Update failed: ' + resp.error);
              }
            })
            .catch(function(err) { alert('Update failed'); });
        }

        if (input.type === 'checkbox') {
          input.addEventListener('change', function() {
            send(input.checked);
          });
        } else {
          input.addEventListener('change', function() { send(input.value); });
          input.addEventListener('blur', function() { send(input.value); });
          input.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); send(input.value); } });
        }
      });
    });
  })();
</script>
{% endblock %}



{% extends 'frontend/base.html' %}

{% block content %}
<style>
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Collapsible filter sections */
.filter-section {
    margin-bottom: 1.5rem;
}

.filter-content {
    transition: all 0.3s ease-in-out;
    overflow: hidden;
}

.filter-chevron {
    transition: transform 0.2s ease-in-out;
}

.cursor-pointer:hover {
    background-color: rgba(0, 0, 0, 0.02);
    border-radius: 0.375rem;
}
</style>
<div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Filter Bar -->
        <div class="sticky top-16 z-40 bg-white border-b border-gray-200 mb-6 -mx-4 px-4 py-3">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <!-- Filter Toggle Button (Mobile) -->
                <button id="filter-toggle" onclick="toggleFilterSidebar()" class="lg:hidden flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    Filters
                </button>
                
                <!-- View Controls -->
                <div class="flex items-center gap-4">
                    <!-- View Toggle -->
                    <div class="flex items-center bg-gray-100 rounded-lg p-1">
                        <button id="grid-view" onclick="toggleView('grid')" class="p-2 rounded-md bg-white shadow-sm text-gray-700 hover:text-blue-600 transition-colors mobile-button mobile-touch-target ripple">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                            </svg>
                        </button>
                        <button id="list-view" onclick="toggleView('list')" class="p-2 rounded-md text-gray-500 hover:text-blue-600 transition-colors mobile-button mobile-touch-target ripple">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Sort Dropdown -->
                    <select id="sortSelect" name="sort" class="text-sm border border-gray-300 rounded px-2 py-1" onchange="handleSortChange(this)">
                        <option value="name" {% if current_filters.sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
                        <option value="name_desc" {% if current_filters.sort == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
                        <option value="brand" {% if current_filters.sort == 'brand' %}selected{% endif %}>Brand (A-Z)</option>
                        <option value="brand_desc" {% if current_filters.sort == 'brand_desc' %}selected{% endif %}>Brand (Z-A)</option>
                        <option value="voltage" {% if current_filters.sort == 'voltage' %}selected{% endif %}>Voltage (Low-High)</option>
                        <option value="voltage_desc" {% if current_filters.sort == 'voltage_desc' %}selected{% endif %}>Voltage (High-Low)</option>
                        <option value="release_date" {% if current_filters.sort == 'release_date' %}selected{% endif %}>Release Date (Newest)</option>
                        <option value="release_date_desc" {% if current_filters.sort == 'release_date_desc' %}selected{% endif %}>Release Date (Oldest)</option>
                    </select>
                    
                    <!-- Results per page -->
                    <select id="results-per-page" onchange="changeResultsPerPage(this.value)" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="12">12 per page</option>
                        <option value="24">24 per page</option>
                        <option value="48">48 per page</option>
                    </select>
                    
                    <!-- Compare Button -->
                    <button id="compare-button" onclick="openCompareModal()" class="hidden bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors">
                        Compare (0)
                    </button>
                    <button id="clear-compare-button" onclick="clearComparison()" class="hidden bg-gray-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Layout -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Filter Sidebar -->
            <div id="filter-sidebar" class="lg:w-1/4 hidden lg:block">
                <div class="bg-white rounded-lg border border-gray-200 p-6 sticky top-32">
                    <!-- Active Filters -->
                    <div id="active-filters" class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-900">Active Filters</h3>
                            <button onclick="clearAllFilters()" class="text-xs text-blue-600 hover:text-blue-800 font-medium">Clear All</button>
                        </div>
                        <div id="active-filter-tags" class="space-y-2">
                            <!-- Active filter tags will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Filter Form -->
                    <form id="filter-form" method="get" action="{% url 'index' %}" class="space-y-6">
                        <!-- Search -->
                        <div>
                            <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                            <input type="text" id="search" name="search" value="{{ current_filters.search }}" 
                                   placeholder="Search products..." 
                                   oninput="debounceSearch()"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- Category Filters -->
                        <div>
                            <h4 class="text-sm font-semibold text-gray-900 mb-3">Category</h4>
                            <div class="space-y-3">
                                <!-- Level 1 Category -->
                                <div>
                                    <label for="category_level1" class="block text-xs font-medium text-gray-600 mb-1">Level 1</label>
                                    <select id="category_level1" name="category_level1" onchange="updateCategoryFilters(); applyFilters()" 
                                            class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">All Categories</option>
                                        {% for category in level1_categories %}
                                            <option value="{{ category.id }}" {% if current_filters.category_level1 == category.id|stringformat:"s" %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Level 2 Category -->
                                <div id="level2-container" {% if not current_filters.category_level1 %}style="display: none;"{% endif %}>
                                    <label for="category_level2" class="block text-xs font-medium text-gray-600 mb-1">Level 2</label>
                                    <select id="category_level2" name="category_level2" onchange="updateCategoryFilters(); applyFilters()" 
                                            class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">All Subcategories</option>
                                        {% for category in level2_categories_with_parent %}
                                            {% if category.parent == current_filters.category_level1 %}
                                                <option value="{{ category.id }}" {% if current_filters.category_level2 == category.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ category.name }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Level 3 Category -->
                                <div id="level3-container" {% if not current_filters.category_level2 %}style="display: none;"{% endif %}>
                                    <label for="category_level3" class="block text-xs font-medium text-gray-600 mb-1">Level 3</label>
                                    <select id="category_level3" name="category_level3" onchange="updateCategoryFilters(); applyFilters()" 
                                            class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">All Sub-subcategories</option>
                                        {% for category in level3_categories_with_parent %}
                                            {% if category.parent == current_filters.category_level2 %}
                                                <option value="{{ category.id }}" {% if current_filters.category_level3 == category.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ category.name }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Brand Filter -->
                        <div class="filter-section">
                            <div class="flex items-center justify-between mb-3 cursor-pointer" onclick="toggleFilterSection('brand')">
                                <h4 class="text-sm font-semibold text-gray-900">Brand</h4>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500" id="brand-count">{{ filter_counts.brands.selected }}/{{ filter_counts.brands.total }}</span>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform duration-200 filter-chevron" id="brand-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="filter-content max-h-48 overflow-y-auto space-y-2" id="brand-content">
                                {% for brand in brands %}
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="brand" value="{{ brand.id }}" 
                                               {% if brand.id in selected_brand_ids %}checked{% endif %}
                                               onchange="applyFilters()"
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                                        <span class="text-gray-700">{{ brand.name }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Voltage Filter -->
                        <div class="filter-section">
                            <div class="flex items-center justify-between mb-3 cursor-pointer" onclick="toggleFilterSection('voltage')">
                                <h4 class="text-sm font-semibold text-gray-900">Voltage</h4>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500" id="voltage-count">{{ filter_counts.voltages.selected }}/{{ filter_counts.voltages.total }}</span>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform duration-200 filter-chevron" id="voltage-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="filter-content max-h-48 overflow-y-auto space-y-2" id="voltage-content">
                                {% for voltage in voltages %}
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="voltage" value="{{ voltage.id }}" 
                                               {% if voltage.id in selected_voltage_ids %}checked{% endif %}
                                               onchange="applyFilters()"
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                                        <span class="text-gray-700">{{ voltage.value }}V</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Platform Filter -->
                        <div class="filter-section">
                            <div class="flex items-center justify-between mb-3 cursor-pointer" onclick="toggleFilterSection('platform')">
                                <h4 class="text-sm font-semibold text-gray-900">Platform</h4>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500" id="platform-count">{{ filter_counts.platforms.selected }}/{{ filter_counts.platforms.total }}</span>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform duration-200 filter-chevron" id="platform-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="filter-content max-h-48 overflow-y-auto space-y-2" id="platform-content">
                                {% for platform in platforms %}
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="platform" value="{{ platform.id }}" 
                                               {% if platform.id in selected_platform_ids %}checked{% endif %}
                                               onchange="applyFilters()"
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                                        <span class="text-gray-700">{{ platform.name }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Status Filter -->
                        <div class="filter-section">
                            <div class="flex items-center justify-between mb-3 cursor-pointer" onclick="toggleFilterSection('status')">
                                <h4 class="text-sm font-semibold text-gray-900">Status</h4>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500" id="status-count">{{ filter_counts.statuses.selected }}/{{ filter_counts.statuses.total }}</span>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform duration-200 filter-chevron" id="status-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="filter-content max-h-48 overflow-y-auto space-y-2" id="status-content">
                                {% for status in statuses %}
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="status" value="{{ status.id }}" 
                                               {% if status.id in selected_status_ids %}checked{% endif %}
                                               onchange="applyFilters()"
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                                        <span class="text-gray-700">{{ status.name }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Release Date Range -->
                        <div class="filter-section">
                            <div class="flex items-center justify-between mb-3 cursor-pointer" onclick="toggleFilterSection('release_date')">
                                <h4 class="text-sm font-semibold text-gray-900">Release Date</h4>
                                <svg class="w-4 h-4 text-gray-400 transition-transform duration-200 filter-chevron" id="release_date-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                            <div class="filter-content space-y-2" id="release_date-content">
                                <div>
                                    <label for="release_date_from" class="block text-xs font-medium text-gray-600 mb-1">From</label>
                                    <input type="date" id="release_date_from" name="release_date_from" 
                                           value="{{ current_filters.release_date_from }}"
                                           onchange="applyFilters()"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="release_date_to" class="block text-xs font-medium text-gray-600 mb-1">To</label>
                                    <input type="date" id="release_date_to" name="release_date_to" 
                                           value="{{ current_filters.release_date_to }}"
                                           onchange="applyFilters()"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="lg:w-3/4">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900" role="status" aria-live="polite">
                        {% if products %}
                            Showing {{ products.start_index }}-{{ products.end_index }} of {{ products.paginator.count }} products
                        {% else %}
                            No products found
                        {% endif %}
                    </h2>
                </div>

                {% if products %}
                    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {% for product in products %}
                            <div class="bg-white rounded-xl shadow-sm border group flex flex-col hover:shadow-lg hover:border-blue-200 transition-all duration-300 mobile-card mobile-touch-target gradient-border">
                                <div class="relative">
                                    <div class="aspect-square bg-white rounded-t-xl overflow-hidden relative">
                                        {% if product.image %}
                                            <img src="{{ product.image }}" alt="{{ product.name }}" class="w-full h-full object-contain p-2 group-hover:scale-105 transition-transform duration-300">
                                        {% else %}
                                            <div class="w-full h-full flex items-center justify-center text-gray-400">
                                                <div class="text-center">
                                                    <svg class="w-16 h-16 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    <p class="text-sm">No Image</p>
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Quick View Overlay -->
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                            <button onclick="openQuickView('{{ product.id }}')" class="bg-white text-gray-900 px-4 py-2 rounded-lg shadow-lg font-medium hover:bg-gray-50 transition-colors ripple">
                                                Quick View
                                            </button>
                                        </div>
                                        
                                        <!-- Compare Checkbox -->
                                        <div class="absolute top-2 right-2 transition-opacity duration-300 opacity-0 group-hover:opacity-100" id="compare-checkbox-{{ product.id }}">
                                            <label class="flex items-center justify-center w-6 h-6 bg-white rounded-full shadow-md cursor-pointer hover:bg-blue-50">
                                                <input type="checkbox" class="compare-checkbox sr-only" data-product-id="{{ product.id }}" onchange="toggleCompare(this)">
                                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center checkbox-visual">
                                                    <svg class="w-3 h-3 text-white hidden checkmark" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-5 flex flex-col flex-grow">
                                    <div class="mb-3">
                                        <h3 class="font-semibold text-gray-900 line-clamp-2 leading-tight mb-2 group-hover:text-blue-600 transition-colors">{{ product.name }}</h3>
                                        {% if product.status.name != 'Active' %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                                {% if product.status.name == 'Discontinued' %}bg-red-100 text-red-800
                                                {% elif product.status.name == 'Pre-release' %}bg-yellow-100 text-yellow-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ product.status.name }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="space-y-2 mb-4">
                                        {% if product.brand %}
                                            <div class="text-sm">
                                                <span id="brand-{{ product.id }}" class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold text-white" 
                                                      data-brand-color="{{ product.brand.color|default:'#6b7280' }}"
                                                      data-brand-bg="{{ product.brand.color|default:'#6b7280' }}">
                                                    {{ product.brand.name }}
                                                </span>
                                            </div>
                                        {% endif %}
                                        {% if product.sku %}
                                            <div class="flex items-center text-sm text-gray-600">
                                                <span class="font-medium w-16">Model#:</span>
                                                <span class="font-medium">{{ product.sku }}</span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="mt-auto">
                                        <a href="{% url 'product_detail' product.id %}" class="block w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg text-sm font-medium hover:bg-blue-700 text-center transition-colors group/btn">
                                            View Details
                                            <svg class="w-4 h-4 inline-block ml-1 group-hover/btn:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if products.has_other_pages %}
                        <div class="mt-8 flex justify-between items-center">
                            <!-- Viewing info -->
                            <div class="text-sm text-gray-600">
                                Viewing <span class="font-semibold">{{ products.start_index }}-{{ products.end_index }}</span> of <span class="font-semibold">{{ products.paginator.count }}</span>
                            </div>
                            
                            <!-- Pagination controls -->
                            <nav class="flex items-center gap-2">
                                <!-- Previous arrow -->
                                {% if products.has_previous %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products.previous_page_number }}" 
                                       class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-xl">
                                        <
                                    </a>
                                {% else %}
                                    <span class="text-gray-300 text-xl"></span>
                                {% endif %}

                                <!-- Page numbers -->
                                {% for num in products.paginator.page_range %}
                                    {% if products.number == num %}
                                        <span class="font-semibold text-gray-900 border-b-2 border-orange-500 text-md">{{ num }}</span>
                                    {% elif num >= products.number|add:'-2' and num <= products.number|add:'2' or products.number <= 3 and num <= 5 %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                    {% elif num == 1 and products.number > 4 %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                        <span class="text-gray-400 text-sm">...</span>
                                    {% elif num == products.paginator.num_pages and products.number < products.paginator.num_pages|add:'-3' %}
                                        <span class="text-gray-400 text-sm">...</span>
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                    {% endif %}
                                {% endfor %}

                                <!-- Next arrow -->
                                {% if products.has_next %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products.next_page_number }}" 
                                       class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-xl">
                                        >
                                    </a>
                                {% else %}
                                    <span class="text-gray-300 text-xl"></span>
                                {% endif %}

                            </nav>
                        </div>
                    {% endif %}
                {% else %}
                    <!-- Enhanced Empty State -->
                    <div class="text-center py-16">
                        <div class="mx-auto w-64 h-64 mb-8 relative">
                            <!-- Empty state illustration -->
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-48 h-48 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center">
                                    <svg class="w-24 h-24 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <!-- Floating elements -->
                            <div class="absolute top-8 left-8 w-8 h-8 bg-yellow-200 rounded-full"></div>
                            <div class="absolute top-16 right-12 w-6 h-6 bg-green-200 rounded-full"></div>
                            <div class="absolute bottom-12 left-12 w-4 h-4 bg-purple-200 rounded-full"></div>
                        </div>
                        
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">No products found</h3>
                        <p class="text-lg text-gray-600 mb-8 max-w-md mx-auto">
                            We couldn't find any products matching your current search and filter criteria.
                        </p>
                        
                        <!-- Suggestions -->
                        <div class="bg-gray-50 rounded-xl p-6 mb-8 max-w-lg mx-auto">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Try these suggestions:</h4>
                            <ul class="text-left space-y-2 text-gray-600">
                                <li class="flex items-center">
                                    <svg class="w-5 h-5 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    Clear some filters to see more results
                                </li>
                                <li class="flex items-center">
                                    <svg class="w-5 h-5 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    Try different search terms
                                </li>
                                <li class="flex items-center">
                                    <svg class="w-5 h-5 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    Browse popular categories
                                </li>
                            </ul>
                        </div>
                        
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick View Modal -->
    <div id="quickViewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50" onclick="closeQuickView()">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white" onclick="event.stopPropagation()">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Quick View</h3>
                    <button onclick="closeQuickView()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div id="quickViewContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>


    <script>
    // Clean, simple JavaScript - no conflicting event handlers
    
    // Function to calculate luminance and determine appropriate text color
    function calculateTextColor(hexColor) {
        hexColor = hexColor.replace('#', '');
        const r = parseInt(hexColor.substr(0, 2), 16);
        const g = parseInt(hexColor.substr(2, 2), 16);
        const b = parseInt(hexColor.substr(4, 2), 16);
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance < 0.5 ? 'white' : 'black';
    }
    
    // Function to apply brand color styling
    function applyBrandColorStyling() {
        document.querySelectorAll('[data-brand-color]').forEach(element => {
            const brandColor = element.getAttribute('data-brand-color');
            const brandBg = element.getAttribute('data-brand-bg');
            if (brandColor && brandBg) {
                const textColor = calculateTextColor(brandColor);
                element.style.color = textColor;
                element.style.backgroundColor = brandBg;
            }
        });
    }
    

    // Clean, single DOMContentLoaded handler
    document.addEventListener('DOMContentLoaded', function() {
        applyBrandColorStyling();
        initializeCompareState();
        initializeFilterState();
        updateActiveFilters();
        console.log('Products UI initialized cleanly');
    });
    
    
    // Global function to handle sort change
    function handleSortChange(selectElement) {
        const urlParams = new URLSearchParams(window.location.search);
        const sortValue = selectElement.value;
        let sortField, sortDirection;
        
        if (sortValue.endsWith('_desc')) {
            sortField = sortValue.replace('_desc', '');
            sortDirection = 'desc';
        } else {
            sortField = sortValue;
            sortDirection = 'asc';
        }
        
        urlParams.set('sort', sortField);
        urlParams.set('sort_direction', sortDirection);
        urlParams.set('page', '1');
        
        window.location.href = '?' + urlParams.toString();
    }
    
    
    function toggleView(viewType) {
        const gridView = document.getElementById('grid-view');
        const listView = document.getElementById('list-view');
        const productGrid = document.getElementById('product-grid');
        
        if (viewType === 'grid') {
            gridView.classList.add('bg-white', 'shadow-sm', 'text-gray-700');
            gridView.classList.remove('text-gray-500');
            listView.classList.remove('bg-white', 'shadow-sm', 'text-gray-700');
            listView.classList.add('text-gray-500');
            
            if (productGrid) {
                productGrid.classList.remove('grid-cols-1');
                productGrid.classList.add('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
            }
        } else {
            listView.classList.add('bg-white', 'shadow-sm', 'text-gray-700');
            listView.classList.remove('text-gray-500');
            gridView.classList.remove('bg-white', 'shadow-sm', 'text-gray-700');
            gridView.classList.add('text-gray-500');
            
            if (productGrid) {
                productGrid.classList.remove('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
                productGrid.classList.add('grid-cols-1');
            }
        }
        
        localStorage.setItem('viewType', viewType);
    }
    
    function changeResultsPerPage(value) {
        const url = new URL(window.location);
        url.searchParams.set('page_size', value);
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }
    
    
    // Quick View and Compare Functions
    function openQuickView(productId) {
        const modal = document.getElementById('quickViewModal');
        const content = document.getElementById('quickViewContent');
        
        modal.classList.remove('hidden');
        content.innerHTML = `
            <div class="flex items-center justify-center p-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-2 text-gray-600">Loading...</span>
            </div>
        `;
        
        fetch(`/api/quick-info/${productId}/?type=product`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    content.innerHTML = `
                        <div class="text-center p-8">
                            <p class="text-red-600">Error loading product details</p>
                        </div>
                    `;
                    return;
                }
                
                const description = data.description || '';
                const truncatedDesc = description.length > 500 ? description.substring(0, 500) + '...' : description;
                const needsExpansion = description.length > 200; // Approximate 3 lines
                
                const batteryPlatformsHtml = data.battery_platforms && data.battery_platforms.length > 0 
                    ? data.battery_platforms.map(platform => 
                        `<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">${platform}</span>`
                      ).join('')
                    : '';
                
                const componentsHtml = data.components && data.components.length > 0
                    ? `<div class="mb-4">
                         <span class="text-sm font-medium text-gray-700">Components:</span>
                         <div class="mt-2 border border-gray-200 rounded-lg overflow-hidden">
                           ${data.components.map((comp, index) => 
                               `<div class="flex items-center text-sm px-3 py-2 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} border-b border-gray-100 last:border-b-0 ${index >= 4 ? 'hidden' : ''}" data-component-index="${index}">
                                  <span class="text-gray-600 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium mr-3 min-w-0 flex-shrink-0">${comp.quantity}</span>
                                  <div class="flex-1 min-w-0">
                                    ${comp.sku ? `<div class="text-xs text-gray-500 mb-1">${comp.sku} ${comp.name}</div>` : ''}
                                  </div>
                                </div>`
                           ).join('')}
                         </div>
                         ${data.components.length > 4 ? `
                           <div class="mt-2 text-center">
                             <button onclick="toggleComponents()" class="text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors" id="toggleComponentsBtn">
                               Show ${data.components.length - 4} more components
                             </button>
                           </div>
                         ` : ''}
                       </div>`
                    : '';
                
                content.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/2">
                            <div class="aspect-square bg-white rounded-lg overflow-hidden border">
                                ${data.image ? 
                                    `<img src="${data.image}" alt="${data.name}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full flex items-center justify-center text-gray-400">
                                        <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>`
                                }
                            </div>
                        </div>
                        <div class="md:w-1/2">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                        ${data.brand || 'Unknown Brand'}
                                    </span>
                                    ${batteryPlatformsHtml ? `<div class="flex gap-1">${batteryPlatformsHtml}</div>` : ''}
                                </div>
                                ${data.sku ? `<span class="text-xs text-gray-500">Model#: ${data.sku}</span>` : ''}
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">${data.name}</h3>
                            ${data.status && data.status !== 'Active' ? `<div class="mb-2"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${data.status === 'Discontinued' ? 'bg-red-100 text-red-800' : data.status === 'Pre-release' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">${data.status}</span></div>` : ''}
                            ${componentsHtml}
                            ${truncatedDesc ? `
                                <div class="mb-4">
                                    <p class="text-gray-700 line-clamp-3" id="descriptionText">${truncatedDesc}</p>
                                    ${needsExpansion ? `
                                        <button onclick="toggleDescription()" class="text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors mt-1" id="toggleDescriptionBtn">
                                            Show more
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                            <div class="flex gap-2">
                                <a href="${data.url}" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg text-center hover:bg-blue-700 transition-colors">
                                    View Full Details
                                </a>
                                <button onclick="closeQuickView()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                content.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-red-600">Error loading product details</p>
                    </div>
                `;
            });
    }
    
    function closeQuickView() {
        const modal = document.getElementById('quickViewModal');
        modal.classList.add('hidden');
    }
    
    function toggleComponents() {
        const hiddenComponents = document.querySelectorAll('[data-component-index]');
        const toggleBtn = document.getElementById('toggleComponentsBtn');
        const isExpanded = toggleBtn.textContent.includes('Show less');
        
        hiddenComponents.forEach(component => {
            const index = parseInt(component.dataset.componentIndex);
            if (index >= 4) {
                if (isExpanded) {
                    component.classList.add('hidden');
                } else {
                    component.classList.remove('hidden');
                }
            }
        });
        
        if (isExpanded) {
            const totalComponents = hiddenComponents.length;
            const hiddenCount = totalComponents - 4;
            toggleBtn.textContent = `Show ${hiddenCount} more components`;
        } else {
            toggleBtn.textContent = 'Show less';
        }
    }
    
    function toggleDescription() {
        const descriptionText = document.getElementById('descriptionText');
        const toggleBtn = document.getElementById('toggleDescriptionBtn');
        const isExpanded = toggleBtn.textContent.includes('Show less');
        
        if (isExpanded) {
            descriptionText.classList.add('line-clamp-3');
            toggleBtn.textContent = 'Show more';
        } else {
            descriptionText.classList.remove('line-clamp-3');
            toggleBtn.textContent = 'Show less';
        }
    }
    
    function toggleCompare(checkbox) {
        const productId = checkbox.dataset.productId;
        const compareList = JSON.parse(localStorage.getItem('compareList') || '[]');
        const checkboxContainer = document.getElementById(`compare-checkbox-${productId}`);
        const checkmark = checkboxContainer.querySelector('.checkmark');
        const checkboxVisual = checkboxContainer.querySelector('.checkbox-visual');
        
        if (checkbox.checked) {
            if (compareList.length >= 4) {
                showToast('You can compare up to 4 products at once.', 'warning');
                checkbox.checked = false;
                return;
            }
            if (!compareList.includes(productId)) {
                compareList.push(productId);
                showToast('Product added to comparison', 'success');
            }
            checkboxVisual.classList.add('bg-blue-600', 'border-blue-600');
            checkmark.classList.remove('hidden');
            checkboxContainer.classList.remove('opacity-0');
            checkboxContainer.classList.add('opacity-100');
        } else {
            const index = compareList.indexOf(productId);
            if (index > -1) {
                compareList.splice(index, 1);
                showToast('Product removed from comparison', 'info');
            }
            checkboxVisual.classList.remove('bg-blue-600', 'border-blue-600');
            checkmark.classList.add('hidden');
            checkboxContainer.classList.add('opacity-0');
            checkboxContainer.classList.remove('opacity-100');
        }
        
        localStorage.setItem('compareList', JSON.stringify(compareList));
        updateCompareButton();
    }
    
    function clearComparison() {
        const compareList = JSON.parse(localStorage.getItem('compareList') || '[]');
        
        compareList.forEach(productId => {
            const checkbox = document.querySelector(`input[data-product-id="${productId}"]`);
            if (checkbox) {
                checkbox.checked = false;
                const checkboxContainer = document.getElementById(`compare-checkbox-${productId}`);
                const checkmark = checkboxContainer.querySelector('.checkmark');
                const checkboxVisual = checkboxContainer.querySelector('.checkbox-visual');
                
                checkboxVisual.classList.remove('bg-blue-600', 'border-blue-600');
                checkmark.classList.add('hidden');
                checkboxContainer.classList.add('opacity-0');
                checkboxContainer.classList.remove('opacity-100');
            }
        });
        
        localStorage.setItem('compareList', JSON.stringify([]));
        updateCompareButton();
        showToast('Comparison cleared', 'info');
    }
    
    function updateCompareButton() {
        const compareList = JSON.parse(localStorage.getItem('compareList') || '[]');
        const compareButton = document.getElementById('compare-button');
        const clearButton = document.getElementById('clear-compare-button');
        
        if (compareButton) {
            if (compareList.length > 0) {
                compareButton.textContent = `Compare (${compareList.length})`;
                compareButton.classList.remove('hidden');
                if (clearButton) clearButton.classList.remove('hidden');
            } else {
                compareButton.classList.add('hidden');
                if (clearButton) clearButton.classList.add('hidden');
            }
        }
    }
    
    function openCompareModal() {
        const compareList = JSON.parse(localStorage.getItem('compareList') || '[]');
        if (compareList.length === 0) {
            alert('Please select products to compare.');
            return;
        }
        
        const compareUrl = `/compare/?products=${compareList.join(',')}`;
        window.location.href = compareUrl;
    }
    
    // Initialize compare state
    function initializeCompareState() {
        const compareList = JSON.parse(localStorage.getItem('compareList') || '[]');
        compareList.forEach(productId => {
            const checkbox = document.querySelector(`input[data-product-id="${productId}"]`);
            if (checkbox) {
                checkbox.checked = true;
                const checkboxContainer = document.getElementById(`compare-checkbox-${productId}`);
                const checkmark = checkboxContainer.querySelector('.checkmark');
                const checkboxVisual = checkboxContainer.querySelector('.checkbox-visual');
                
                checkboxVisual.classList.add('bg-blue-600', 'border-blue-600');
                checkmark.classList.remove('hidden');
                checkboxContainer.classList.remove('opacity-0');
                checkboxContainer.classList.add('opacity-100');
            }
        });
        updateCompareButton();
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
            type === 'success' ? 'bg-green-500' : 
            type === 'warning' ? 'bg-yellow-500' : 
            type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Filter Functions
    let searchTimeout;
    
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyFilters();
        }, 500); // Wait 500ms after user stops typing
    }

    function applyFilters() {
        const form = document.getElementById('filter-form');
        const formData = new FormData(form);
        const url = new URL(window.location);
        
        // Update active filters and counts immediately to show changes right away
        updateActiveFilters();
        
        // Clear existing filter parameters
        const filterParams = ['search', 'brand', 'voltage', 'platform', 'status', 'category_level1', 'category_level2', 'category_level3', 'release_date_from', 'release_date_to'];
        filterParams.forEach(param => url.searchParams.delete(param));
        
        // Add current form values
        for (let [key, value] of formData.entries()) {
            if (value) {
                url.searchParams.append(key, value);
            }
        }
        
        // Reset to page 1 when filtering
        url.searchParams.set('page', '1');
        
        // Fetch new content without page reload
        fetch(url.toString())
            .then(response => response.text())
            .then(html => {
                // Parse the response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Update product grid
                const newProductGrid = doc.getElementById('product-grid');
                if (newProductGrid) {
                    const productGrid = document.getElementById('product-grid');
                    productGrid.innerHTML = newProductGrid.innerHTML;
                }
                
                // Update results header
                const newHeader = doc.querySelector('h2[role="status"]');
                if (newHeader) {
                    const resultsHeader = document.querySelector('h2[role="status"]');
                    resultsHeader.textContent = newHeader.textContent;
                }
                
                // Update pagination
                const newPagination = doc.querySelector('.mt-8');
                const currentPagination = document.querySelector('.mt-8');
                if (newPagination && currentPagination) {
                    currentPagination.innerHTML = newPagination.innerHTML;
                }
                
                // Update active filters and counts again after content update
                updateActiveFilters();
                
                // Update URL without reload
                window.history.pushState({}, '', url.toString());
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback to page reload if AJAX fails
                window.location.href = url.toString();
            });
    }

    function toggleFilterSidebar() {
        const sidebar = document.getElementById('filter-sidebar');
        sidebar.classList.toggle('hidden');
    }

    function updateCategoryFilters() {
        const level1 = document.getElementById('category_level1');
        const level2 = document.getElementById('category_level2');
        const level3 = document.getElementById('category_level3');
        const level2Container = document.getElementById('level2-container');
        const level3Container = document.getElementById('level3-container');

        // Reset lower levels when higher level changes
        if (level1.value !== '{{ current_filters.category_level1 }}') {
            level2.value = '';
            level3.value = '';
            level2Container.style.display = 'none';
            level3Container.style.display = 'none';
        }
        if (level2.value !== '{{ current_filters.category_level2 }}') {
            level3.value = '';
            level3Container.style.display = 'none';
        }

        // Show/hide containers based on selection
        if (level1.value) {
            level2Container.style.display = 'block';
            // Load level 2 options dynamically
            loadCategoryOptions('level2', level1.value);
        } else {
            level2Container.style.display = 'none';
            level3Container.style.display = 'none';
        }

        if (level2.value) {
            level3Container.style.display = 'block';
            // Load level 3 options dynamically
            loadCategoryOptions('level3', level2.value);
        } else {
            level3Container.style.display = 'none';
        }
    }

    function loadCategoryOptions(level, parentId) {
        const container = document.getElementById(`${level}-container`);
        const select = document.getElementById(`category_${level}`);
        
        // Show loading state
        select.innerHTML = '<option value="">Loading...</option>';
        
        // Fetch options from server
        const url = new URL(window.location);
        url.searchParams.set('parent_id', parentId);
        url.searchParams.set('level', level);
        
        fetch(`/api/filter-options/?${url.searchParams.toString()}`)
            .then(response => response.json())
            .then(data => {
                const options = data[`${level}_categories`] || [];
                select.innerHTML = `<option value="">All ${level === 'level2' ? 'Subcategories' : 'Sub-subcategories'}</option>`;
                
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.id;
                    optionElement.textContent = option.name;
                    select.appendChild(optionElement);
                });
            })
            .catch(error => {
                console.error('Error loading category options:', error);
                select.innerHTML = `<option value="">Error loading options</option>`;
            });
    }

    function updateActiveFilters() {
        const container = document.getElementById('active-filter-tags');
        const filters = getActiveFilters();
        
        container.innerHTML = '';
        
        if (filters.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 italic">No filters applied</p>';
            return;
        }
        
        filters.forEach(filter => {
            const tag = document.createElement('div');
            tag.className = 'inline-flex items-center gap-1 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full';
            tag.innerHTML = `
                <span>${filter.label}</span>
                <button onclick="removeFilter('${filter.type}', '${filter.value}')" class="ml-1 hover:text-blue-900">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;
            container.appendChild(tag);
        });
        
        // Update filter counts
        updateFilterCounts();
    }
    
    function updateFilterCounts() {
        const form = document.getElementById('filter-form');
        const formData = new FormData(form);
        
        // Update brand count
        const brandCount = formData.getAll('brand').length;
        const brandCountElement = document.getElementById('brand-count');
        if (brandCountElement) {
            const totalBrands = brandCountElement.textContent.split('/')[1];
            brandCountElement.textContent = `${brandCount}/${totalBrands}`;
        }
        
        // Update voltage count
        const voltageCount = formData.getAll('voltage').length;
        const voltageCountElement = document.getElementById('voltage-count');
        if (voltageCountElement) {
            const totalVoltages = voltageCountElement.textContent.split('/')[1];
            voltageCountElement.textContent = `${voltageCount}/${totalVoltages}`;
        }
        
        // Update platform count
        const platformCount = formData.getAll('platform').length;
        const platformCountElement = document.getElementById('platform-count');
        if (platformCountElement) {
            const totalPlatforms = platformCountElement.textContent.split('/')[1];
            platformCountElement.textContent = `${platformCount}/${totalPlatforms}`;
        }
        
        // Update status count
        const statusCount = formData.getAll('status').length;
        const statusCountElement = document.getElementById('status-count');
        if (statusCountElement) {
            const totalStatuses = statusCountElement.textContent.split('/')[1];
            statusCountElement.textContent = `${statusCount}/${totalStatuses}`;
        }
    }

    function getActiveFilters() {
        const filters = [];
        const form = document.getElementById('filter-form');
        const formData = new FormData(form);
        
        // Search filter
        const search = formData.get('search');
        if (search) {
            filters.push({ type: 'search', value: search, label: `Search: "${search}"` });
        }
        
        // Brand filters
        const brands = formData.getAll('brand');
        brands.forEach(brandId => {
            const brandName = getBrandName(brandId);
            if (brandName) {
                filters.push({ type: 'brand', value: brandId, label: `Brand: ${brandName}` });
            }
        });
        
        // Voltage filters
        const voltages = formData.getAll('voltage');
        voltages.forEach(voltageId => {
            const voltageValue = getVoltageValue(voltageId);
            if (voltageValue) {
                filters.push({ type: 'voltage', value: voltageId, label: `Voltage: ${voltageValue}V` });
            }
        });
        
        // Platform filters
        const platforms = formData.getAll('platform');
        platforms.forEach(platformId => {
            const platformName = getPlatformName(platformId);
            if (platformName) {
                filters.push({ type: 'platform', value: platformId, label: `Platform: ${platformName}` });
            }
        });
        
        // Status filters
        const statuses = formData.getAll('status');
        statuses.forEach(statusId => {
            const statusName = getStatusName(statusId);
            if (statusName) {
                filters.push({ type: 'status', value: statusId, label: `Status: ${statusName}` });
            }
        });
        
        // Category filters
        const category1 = formData.get('category_level1');
        if (category1) {
            const categoryName = getCategoryName(category1);
            if (categoryName) {
                filters.push({ type: 'category_level1', value: category1, label: `Category: ${categoryName}` });
            }
        }
        
        const category2 = formData.get('category_level2');
        if (category2) {
            const categoryName = getCategoryName(category2);
            if (categoryName) {
                filters.push({ type: 'category_level2', value: category2, label: `Subcategory: ${categoryName}` });
            }
        }
        
        const category3 = formData.get('category_level3');
        if (category3) {
            const categoryName = getCategoryName(category3);
            if (categoryName) {
                filters.push({ type: 'category_level3', value: category3, label: `Sub-subcategory: ${categoryName}` });
            }
        }
        
        // Date filters
        const dateFrom = formData.get('release_date_from');
        if (dateFrom) {
            filters.push({ type: 'release_date_from', value: dateFrom, label: `From: ${dateFrom}` });
        }
        
        const dateTo = formData.get('release_date_to');
        if (dateTo) {
            filters.push({ type: 'release_date_to', value: dateTo, label: `To: ${dateTo}` });
        }
        
        return filters;
    }

    function getBrandName(brandId) {
        const brandSelect = document.querySelector(`input[name="brand"][value="${brandId}"]`);
        return brandSelect ? brandSelect.nextElementSibling.textContent : null;
    }

    function getVoltageValue(voltageId) {
        const voltageSelect = document.querySelector(`input[name="voltage"][value="${voltageId}"]`);
        return voltageSelect ? voltageSelect.nextElementSibling.textContent.replace('V', '') : null;
    }

    function getPlatformName(platformId) {
        const platformSelect = document.querySelector(`input[name="platform"][value="${platformId}"]`);
        return platformSelect ? platformSelect.nextElementSibling.textContent : null;
    }

    function getStatusName(statusId) {
        const statusSelect = document.querySelector(`input[name="status"][value="${statusId}"]`);
        return statusSelect ? statusSelect.nextElementSibling.textContent : null;
    }

    function getCategoryName(categoryId) {
        const categorySelect = document.querySelector(`select[name="category_level1"], select[name="category_level2"], select[name="category_level3"]`);
        if (categorySelect) {
            const option = categorySelect.querySelector(`option[value="${categoryId}"]`);
            return option ? option.textContent : null;
        }
        return null;
    }

    function removeFilter(type, value) {
        // Update form state first
        if (type === 'search') {
            const searchInput = document.getElementById('search');
            if (searchInput) searchInput.value = '';
        } else if (['brand', 'voltage', 'platform', 'status'].includes(type)) {
            const checkbox = document.querySelector(`input[name="${type}"][value="${value}"]`);
            if (checkbox) checkbox.checked = false;
        } else if (['category_level1', 'category_level2', 'category_level3'].includes(type)) {
            const select = document.querySelector(`select[name="${type}"]`);
            if (select) select.value = '';
            // Also clear lower level categories
            if (type === 'category_level1') {
                const level2Select = document.querySelector('select[name="category_level2"]');
                const level3Select = document.querySelector('select[name="category_level3"]');
                if (level2Select) level2Select.value = '';
                if (level3Select) level3Select.value = '';
            } else if (type === 'category_level2') {
                const level3Select = document.querySelector('select[name="category_level3"]');
                if (level3Select) level3Select.value = '';
            }
        } else if (['release_date_from', 'release_date_to'].includes(type)) {
            const input = document.querySelector(`input[name="${type}"]`);
            if (input) input.value = '';
        }
        
        // Update counts immediately
        updateFilterCounts();
        
        // Then redirect
        const url = new URL(window.location);
        
        if (type === 'search') {
            url.searchParams.delete('search');
        } else if (['brand', 'voltage', 'platform', 'status'].includes(type)) {
            const values = url.searchParams.getAll(type);
            const newValues = values.filter(v => v !== value);
            url.searchParams.delete(type);
            newValues.forEach(v => url.searchParams.append(type, v));
        } else if (['category_level1', 'category_level2', 'category_level3'].includes(type)) {
            url.searchParams.delete(type);
            // Also clear lower level categories
            if (type === 'category_level1') {
                url.searchParams.delete('category_level2');
                url.searchParams.delete('category_level3');
            } else if (type === 'category_level2') {
                url.searchParams.delete('category_level3');
            }
        } else if (['release_date_from', 'release_date_to'].includes(type)) {
            url.searchParams.delete(type);
        }
        
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }

    function clearAllFilters() {
        // Clear all form inputs first
        const form = document.getElementById('filter-form');
        if (form) {
            // Clear search
            const searchInput = document.getElementById('search');
            if (searchInput) searchInput.value = '';
            
            // Clear all checkboxes
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            
            // Clear all selects
            const selects = form.querySelectorAll('select');
            selects.forEach(select => select.value = '');
            
            // Clear date inputs
            const dateInputs = form.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => input.value = '');
        }
        
        // Update counts immediately
        updateFilterCounts();
        
        // Then redirect
        const url = new URL(window.location);
        // Keep only sort and page parameters
        const sort = url.searchParams.get('sort');
        const sortDirection = url.searchParams.get('sort_direction');
        
        url.search = '';
        if (sort) url.searchParams.set('sort', sort);
        if (sortDirection) url.searchParams.set('sort_direction', sortDirection);
        
        window.location.href = url.toString();
    }

    function initializeFilterState() {
        // Initialize category dropdowns based on current state
        const level1 = document.getElementById('category_level1');
        const level2 = document.getElementById('category_level2');
        const level3 = document.getElementById('category_level3');
        
        if (level1 && level1.value) {
            updateCategoryFilters();
        }
        
        // Initialize filter sections - all collapsed by default
        const filterSections = ['brand', 'voltage', 'platform', 'status', 'release_date'];
        filterSections.forEach(section => {
            const content = document.getElementById(`${section}-content`);
            const chevron = document.getElementById(`${section}-chevron`);
            if (content && chevron) {
                content.style.display = 'none';
                chevron.style.transform = 'rotate(-90deg)';
            }
        });
    }
    
    function toggleFilterSection(sectionName) {
        const content = document.getElementById(`${sectionName}-content`);
        const chevron = document.getElementById(`${sectionName}-chevron`);
        
        if (content && chevron) {
            const isCollapsed = content.style.display === 'none';
            
            if (isCollapsed) {
                content.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                chevron.style.transform = 'rotate(-90deg)';
            }
        }
    }
    </script>
{% endblock %}
{% extends 'frontend/base.html' %}

{% block content %}
<div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Quick Navigation Bar -->
        <div class="sticky top-16 z-40 bg-white border-b border-gray-200 mb-6 -mx-4 px-4 py-3">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <!-- Category Shortcuts -->
                <div class="flex flex-wrap gap-2">
                    <span class="text-sm font-medium text-gray-700">Quick Filters:</span>
                    {% if brands %}
                    <button onclick="quickFilter('brand', '{{ brands.0.id }}')" class="px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 transition-colors">
                        {{ brands.0.name }}
                    </button>
                    {% endif %}
                    {% if voltages %}
                    <button onclick="quickFilter('voltage', '{{ voltages.0.id }}')" class="px-3 py-1 text-xs bg-green-100 text-green-800 rounded-full hover:bg-green-200 transition-colors">
                        {{ voltages.0.value }}V
                    </button>
                    {% endif %}
                    {% if platforms %}
                    <button onclick="quickFilter('platform', '{{ platforms.0.id }}')" class="px-3 py-1 text-xs bg-purple-100 text-purple-800 rounded-full hover:bg-purple-200 transition-colors">
                        {{ platforms.0.name }}
                    </button>
                    {% endif %}
                </div>
                
                <!-- View Controls -->
                <div class="flex items-center gap-4">
                    <!-- View Toggle -->
                    <div class="flex items-center bg-gray-100 rounded-lg p-1">
                        <button id="grid-view" onclick="toggleView('grid')" class="p-2 rounded-md bg-white shadow-sm text-gray-700 hover:text-blue-600 transition-colors mobile-button mobile-touch-target ripple">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                            </svg>
                        </button>
                        <button id="list-view" onclick="toggleView('list')" class="p-2 rounded-md text-gray-500 hover:text-blue-600 transition-colors mobile-button mobile-touch-target ripple">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3zm0 4a1 1 0 000 2h14a1 1 0 100-2H3z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Compare Button -->
                    <button id="compare-button" onclick="openCompareModal()" disabled class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors text-sm mobile-button mobile-touch-target ripple">
                        Compare (0)
                    </button>
                    <button id="clear-compare-button" onclick="clearComparison()" class="hidden bg-gray-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                    
                    <!-- Sort Dropdown -->
                    <select id="sortSelect" name="sort" class="text-sm border border-gray-300 rounded px-2 py-1" onchange="handleSortChange(this)">
                        <option value="name" {% if current_filters.sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
                        <option value="name_desc" {% if current_filters.sort == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
                        <option value="brand" {% if current_filters.sort == 'brand' %}selected{% endif %}>Brand (A-Z)</option>
                        <option value="brand_desc" {% if current_filters.sort == 'brand_desc' %}selected{% endif %}>Brand (Z-A)</option>
                        <option value="voltage" {% if current_filters.sort == 'voltage' %}selected{% endif %}>Voltage (Low-High)</option>
                        <option value="voltage_desc" {% if current_filters.sort == 'voltage_desc' %}selected{% endif %}>Voltage (High-Low)</option>
                        {% if show_fair_price %}
                        <option value="fair_price" {% if current_filters.sort == 'fair_price' %}selected{% endif %}>Fair Price (Low-High)</option>
                        <option value="fair_price_desc" {% if current_filters.sort == 'fair_price_desc' %}selected{% endif %}>Fair Price (High-Low)</option>
                        {% endif %}
                    </select>
                    
                    <!-- Results per page -->
                    <select id="results-per-page" onchange="changeResultsPerPage(this.value)" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="12">12 per page</option>
                        <option value="24">24 per page</option>
                        <option value="48">48 per page</option>
                    </select>
                    
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Filters Sidebar -->
            <div class="lg:w-1/4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-md font-semibold text-gray-900 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                        </svg>
                        Filters
                    </h2>
                        {% if current_filters.search or current_filters.brand or current_filters.voltage or current_filters.platform or current_filters.category_level1 or current_filters.category_level2 or current_filters.category_level3 or current_filters.product_line or selected_attribute_filters or selected_feature_filters %}
                            <a href="?" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                Clear All
                            </a>
                        {% endif %}
                    </div>
                    
                    <!-- Active Filters -->
                    {% if current_filters.search or current_filters.brand or current_filters.voltage or current_filters.platform or current_filters.category_level1 or current_filters.category_level2 or current_filters.category_level3 or current_filters.product_line or selected_attribute_filters or selected_feature_filters %}
                    <div class="mb-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Active Filters</h3>
                        <div class="flex flex-wrap gap-2" id="activeFilters">
                            {% if current_filters.search %}
                                <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                    Search: {{ current_filters.search }}
                                    <button type="button" onclick="clearSearch()" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                </span>
                            {% endif %}
                            
                            {% for brand in brands %}
                                {% if brand.id|stringformat:"s" in selected_brand_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ brand.name }}
                                        <button type="button" onclick="removeFilter('brand', '{{ brand.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            {% for voltage in voltages %}
                                {% if voltage.id|stringformat:"s" in selected_voltage_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ voltage.value }}V
                                        <button type="button" onclick="removeFilter('voltage', '{{ voltage.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            {% for platform in platforms %}
                                {% if platform.id|stringformat:"s" in selected_platform_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ platform.name }}
                                        <button type="button" onclick="removeFilter('platform', '{{ platform.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            {% for product_line in product_lines %}
                                {% if product_line.id|stringformat:"s" in selected_product_line_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ product_line.name }}
                                        <button type="button" onclick="removeFilter('product_line', '{{ product_line.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            {% for feature in features %}
                                {% if feature.id in selected_feature_filters %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">
                                        {{ feature.name }}
                                        <button type="button" onclick="removeFilter('feature_{{ feature.id }}', 'Yes')" class="ml-1 text-green-600 hover:text-green-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <form method="get" id="filter-form">
                        <!-- Search -->
                        <div class="filter-section mb-2 bg-gray-50 p-2 rounded-lg">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                                <div class="relative">
                                    <input type="text" name="search" value="{{ current_filters.search }}" 
                                           placeholder="Search components..." 
                                           class="w-full px-3 py-2 pl-10 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           id="search-input">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    </div>
                                    {% if current_filters.search %}
                                        <button type="button" onclick="clearSearch()" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                            <svg class="h-4 w-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Category Filters -->
                        <div class="filter-section mb-6 bg-gray-50 p-4 rounded-lg">
                            <div class="space-y-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                    <select name="category_level1" id="category_level1" class="w-full custom-select">
                                        <option value="">All Categories</option>
                                        {% for category in level1_categories %}
                                            <option value="{{ category.id }}" {% if current_filters.category_level1 == category.id|stringformat:"s" %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <!--<label class="block text-sm font-medium text-gray-700 mb-1">Subcategory</label>-->
                                    <select name="category_level2" id="category_level2" class="w-full custom-select">
                                        <option value="">All Subcategories</option>
                                        {% for category in level2_categories_with_parent %}
                                            <option value="{{ category.id }}" data-parent="{{ category.parent }}" {% if current_filters.category_level2 == category.id|stringformat:"s" %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <!--<label class="block text-sm font-medium text-gray-700 mb-1">Product Type</label>-->
                                    <select name="category_level3" id="category_level3" class="w-full custom-select">
                                        <option value="">All Product Types</option>
                                        {% for category in level3_categories_with_parent %}
                                            <option value="{{ category.id }}" data-parent="{{ category.parent }}" {% if current_filters.category_level3 == category.id|stringformat:"s" %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>


                        <!-- Brand Filter -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('brand')" 
                                    aria-expanded="true" 
                                    aria-controls="brand-content"
                                    aria-labelledby="brand-header"
                                    onkeydown="handleFilterKeydown(event, 'brand')" tabindex="0">
                                <span id="brand-header" class="text-sm font-medium text-gray-700">
                                    Brand
                                    {% if filter_counts.brands.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.brands.selected }}/{{ filter_counts.brands.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="brand-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="brand-content" class="mt-2" role="region" aria-labelledby="brand-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Brand filter options">
                                    {% for brand in brands %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="brand_{{ brand.id }}">
                                            <input type="checkbox" name="brand" value="{{ brand.id }}" 
                                                       {% if brand.id|stringformat:"s" in selected_brand_ids %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="brand_{{ brand.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ brand.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Voltage Filter -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('voltage')" 
                                    aria-expanded="true" 
                                    aria-controls="voltage-content"
                                    aria-labelledby="voltage-header"
                                    onkeydown="handleFilterKeydown(event, 'voltage')" tabindex="0">
                                <span id="voltage-header" class="text-sm font-medium text-gray-700">
                                    Voltage
                                    {% if filter_counts.voltages.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.voltages.selected }}/{{ filter_counts.voltages.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="voltage-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="voltage-content" class="mt-2" role="region" aria-labelledby="voltage-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Voltage filter options">
                                    {% for voltage in voltages %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="voltage_{{ voltage.id }}">
                                            <input type="checkbox" name="voltage" value="{{ voltage.id }}" 
                                                   {% if voltage.id|stringformat:"s" in selected_voltage_ids %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="voltage_{{ voltage.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ voltage.value }}V</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Platform Filter -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('platform')" 
                                    aria-expanded="true" 
                                    aria-controls="platform-content"
                                    aria-labelledby="platform-header"
                                    onkeydown="handleFilterKeydown(event, 'platform')" tabindex="0">
                                <span id="platform-header" class="text-sm font-medium text-gray-700">
                                    Platform
                                    {% if filter_counts.platforms.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.platforms.selected }}/{{ filter_counts.platforms.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="platform-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="platform-content" class="mt-2" role="region" aria-labelledby="platform-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Platform filter options">
                                    {% for platform in platforms %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="platform_{{ platform.id }}">
                                            <input type="checkbox" name="platform" value="{{ platform.id }}" 
                                                   {% if platform.id|stringformat:"s" in selected_platform_ids %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="platform_{{ platform.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ platform.name }}</span>
                                                    </label>
                                                {% endfor %}
                                            </div>
                            </div>
                        </div>

                        <!-- Product Lines Filter -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('product_line')" 
                                    aria-expanded="true" 
                                    aria-controls="product_line-content"
                                    aria-labelledby="product_line-header"
                                    onkeydown="handleFilterKeydown(event, 'product_line')" tabindex="0">
                                <span id="product_line-header" class="text-sm font-medium text-gray-700">
                                    Product Lines
                                    {% if filter_counts.product_lines.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.product_lines.selected }}/{{ filter_counts.product_lines.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="product_line-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="product_line-content" class="mt-2" role="region" aria-labelledby="product_line-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Product Lines filter options">
                                    {% for product_line in product_lines %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="product_line_{{ product_line.id }}">
                                            <input type="checkbox" name="product_line" value="{{ product_line.id }}" 
                                                   {% if product_line.id|stringformat:"s" in selected_product_line_ids %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="product_line_{{ product_line.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ product_line.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Features Filter -->
                        {% if features %}
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('features')" 
                                    aria-expanded="true" 
                                    aria-controls="features-content"
                                    aria-labelledby="features-header"
                                    onkeydown="handleFilterKeydown(event, 'features')" tabindex="0">
                                <span id="features-header" class="text-sm font-medium text-gray-700">Features</span>
                                <svg class="w-4 h-4 transform transition-transform" id="features-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="features-content" class="mt-2" role="region" aria-labelledby="features-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Features filter options">
                                    {% for feature in features %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="feature_{{ feature.id }}">
                                            <input type="checkbox" name="feature_{{ feature.id }}" value="Yes" 
                                                   {% if feature.id in selected_feature_filters %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="feature_{{ feature.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ feature.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Technical Attributes Filter -->
                        {% if attributes %}
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('attributes')" 
                                    aria-expanded="true" 
                                    aria-controls="attributes-content"
                                    aria-labelledby="attributes-header"
                                    onkeydown="handleFilterKeydown(event, 'attributes')" tabindex="0">
                                <span id="attributes-header" class="text-sm font-medium text-gray-700">Technical Attributes</span>
                                <svg class="w-4 h-4 transform transition-transform" id="attributes-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="attributes-content" class="mt-2 space-y-4" role="region" aria-labelledby="attributes-header">
                                {% for attr in attributes %}
                                    <div>
                                        <h4 class="text-sm font-medium text-gray-700 mb-2">{{ attr.name }}{% if attr.unit %} ({{ attr.unit }}){% endif %}</h4>
                                        <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2">
                                            {% for value in attr.values %}
                                                <label class="flex items-center mb-1">
                                                    <input type="checkbox" name="attr_{{ attr.id }}" value="{{ value }}" 
                                                           {% if attr.id in selected_attribute_filters and value in selected_attribute_filters|default:"" %}checked{% endif %}
                                                           onchange="setTimeout(() => this.form.submit(), 10)"
                                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                    <span class="ml-2 text-sm text-gray-700">{{ value }}</span>
                                                </label>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- Main Content -->
            <div class="lg:w-3/4">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">
                        {% if components %}
                            Showing {{ components.start_index }}-{{ components.end_index }} of {{ components.paginator.count }} components
                        {% else %}
                            No components found
                        {% endif %}
                    </h2>
                </div>

                {% if components %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {% for component in components %}
                            <div class="bg-white rounded-xl shadow-sm border group flex flex-col hover:shadow-lg hover:border-blue-200 transition-all duration-300 transform hover:-translate-y-1 hover-lift animate-fade-in mobile-card mobile-touch-target gradient-border">
                                <div class="relative">
                                    <div class="aspect-square bg-white rounded-t-xl overflow-hidden relative">
                                        {% if component.image %}
                                            <img src="{{ component.image }}" alt="{{ component.name }}" class="w-full h-full object-contain p-2 group-hover:scale-105 transition-transform duration-300">
                                        {% else %}
                                            <div class="w-full h-full flex items-center justify-center text-gray-400">
                                                <div class="text-center">
                                                    <svg class="w-16 h-16 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                                </svg>
                                                <p class="text-sm">No Image</p>
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Quick View Overlay -->
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                            <button onclick="openQuickView('{{ component.id }}')" class="bg-white text-gray-900 px-4 py-2 rounded-lg shadow-lg font-medium hover:bg-gray-50 transition-colors ripple">
                                                Quick View
                                            </button>
                                        </div>
                                        
                                        <!-- Compare Checkbox -->
                                        <div class="absolute top-2 right-2 transition-opacity duration-300" id="compare-checkbox-{{ component.id }}">
                                            <label class="flex items-center justify-center w-6 h-6 bg-white rounded-full shadow-md cursor-pointer hover:bg-blue-50">
                                                <input type="checkbox" class="compare-checkbox sr-only" data-component-id="{{ component.id }}" onchange="toggleCompare(this)">
                                                <div class="w-4 h-4 border-2 border-gray-300 rounded flex items-center justify-center checkbox-visual">
                                                    <svg class="w-3 h-3 text-white hidden checkmark" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-5 flex flex-col flex-grow">
                                    <div class="mb-3">
                                        <h3 class="font-semibold text-gray-900 line-clamp-2 leading-tight mb-2 group-hover:text-blue-600 transition-colors">{{ component.name }}</h3>
                                    </div>
                                    <div class="space-y-2 mb-4">
                                        {% if component.brand %}
                                            <div class="text-sm">
                                                <span id="brand-{{ component.id }}" class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold" 
                                                      style="background-color: {{ component.brand.color|default:'#6b7280' }}; color: white;"
                                                      data-brand-color="{{ component.brand.color|default:'#6b7280' }}">
                                                    {{ component.brand.name }}
                                                </span>
                                            </div>
                                        {% endif %}
                                        {% if component.sku %}
                                            <div class="flex items-center text-sm text-gray-600">
                                                <span class="font-medium w-16">Model#:</span>
                                                <span class="font-medium">{{ component.sku }}</span>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Fair Price Badge -->
                                        {% if show_fair_price and component.fair_price_narrative %}
                                            <div class="mt-2">
                                                <!-- Hidden data elements for this component -->
                                                <div id="component-{{ component.id }}-data" style="display: none;">
                                                    <span id="component-{{ component.id }}-name">{{ component.name }}</span>
                                                    <span id="component-{{ component.id }}-sku">{{ component.sku|default:"" }}</span>
                                                    <span id="component-{{ component.id }}-fair-price">{{ component.fair_price_narrative.fair_price|default:"" }}</span>
                                                    <span id="component-{{ component.id }}-reasoning">{{ component.fair_price_narrative.reasoning|default:"" }}</span>
                                                    <span id="component-{{ component.id }}-pros">{{ component.fair_price_narrative.pros|join:"|||" }}</span>
                                                    <span id="component-{{ component.id }}-cons">{{ component.fair_price_narrative.cons|join:"|||" }}</span>
                                                    <span id="component-{{ component.id }}-market-notes">{{ component.fair_price_narrative.market_notes|default:"" }}</span>
                                                </div>
                                                <button onclick="openFairPriceModal('{{ component.id }}')" 
                                                        class="inline-flex items-center px-2 py-1 text-xs font-medium bg-emerald-50 text-emerald-700 rounded-full hover:bg-emerald-100 transition-colors">
                                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                    </svg>
                                                    {% if component.fair_price_narrative.fair_price %}
                                                        {% if component.fair_price_narrative.fair_price|add:0 %}
                                                            Fair Value: ${{ component.fair_price_narrative.fair_price|floatformat:0 }}
                                                        {% else %}
                                                            Value Guide Available
                                                        {% endif %}
                                                    {% else %}
                                                        Value Guide Available
                                                    {% endif %}
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="mt-auto">
                                        <a href="{% url 'component_detail' component.id %}" class="block w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg text-sm font-medium hover:bg-blue-700 text-center transition-colors group/btn">
                                            View Details
                                            <svg class="w-4 h-4 inline-block ml-1 group-hover/btn:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if components.has_other_pages %}
                        <div class="mt-8 flex justify-between items-center">
                            <!-- Viewing info -->
                            <div class="text-sm text-gray-600">
                                Viewing <span class="font-semibold">{{ components.start_index }}-{{ components.end_index }}</span> of <span class="font-semibold">{{ components.paginator.count }}</span>
                            </div>
                            
                            <!-- Pagination controls -->
                            <nav class="flex items-center gap-2">
                                <!-- Previous arrow -->
                                {% if components.has_previous %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ components.previous_page_number }}" 
                                       class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-xl">
                                        <
                                    </a>
                                {% else %}
                                    <span class="text-gray-300 text-xl"></span>
                                {% endif %}

                                <!-- Page numbers -->
                                {% for num in components.paginator.page_range %}
                                    {% if num == components.number %}
                                        <span class="font-semibold text-gray-900 border-b-2 border-orange-500 text-md">{{ num }}</span>
                                    {% elif num >= components.number|add:'-2' and num <= components.number|add:'2' or components.number <= 3 and num <= 5 %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                    {% elif num == 1 and components.number > 4 %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                        <span class="text-gray-400 text-sm">...</span>
                                    {% elif num == components.paginator.num_pages and components.number < components.paginator.num_pages|add:'-3' %}
                                        <span class="text-gray-400 text-sm">...</span>
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                    {% endif %}
                                {% endfor %}

                                <!-- Next arrow -->
                                {% if components.has_next %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ components.next_page_number }}" 
                                       class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-xl">
                                        >
                                    </a>
                                {% else %}
                                    <span class="text-gray-300 text-xl"></span>
                                {% endif %}

                            </nav>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-12">
                        <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.824-2.491"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No components found</h3>
                        <p class="text-gray-500">Try adjusting your filters or search terms.</p>
                    </div>
                {% endif %}
            </div>
            </div>
        </div>
    </div>

    <!-- Quick View Modal -->
    <div id="quickViewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50" onclick="closeQuickView()">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white" onclick="event.stopPropagation()">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Quick View</h3>
                    <button onclick="closeQuickView()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div id="quickViewContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Fair Price Modal -->
    <div id="fairPriceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900" id="modalTitle">Fair Value Analysis</h3>
                    <button onclick="closeFairPriceModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="space-y-4" id="modalContent">
                    <!-- Component Info -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-900" id="componentName"></h4>
                        <p class="text-sm text-gray-600" id="componentSku"></p>
                    </div>
                    
                    <!-- Fair Price -->
                    <div class="bg-emerald-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-emerald-900 mb-2">Fair Value Price</h4>
                        <p class="text-2xl font-bold text-emerald-700" id="fairPrice"></p>
                    </div>
                    
                    <!-- Reasoning -->
                    <div id="reasoningSection" class="hidden">
                        <h4 class="font-semibold text-gray-900 mb-2">Analysis</h4>
                        <p class="text-gray-700" id="reasoning"></p>
                    </div>
                    
                    <!-- Pros -->
                    <div id="prosSection" class="hidden">
                        <h4 class="font-semibold text-green-900 mb-2">Pros</h4>
                        <ul class="list-disc list-inside text-gray-700 space-y-1" id="prosList"></ul>
                    </div>
                    
                    <!-- Cons -->
                    <div id="consSection" class="hidden">
                        <h4 class="font-semibold text-red-900 mb-2">Cons</h4>
                        <ul class="list-disc list-inside text-gray-700 space-y-1" id="consList"></ul>
                    </div>
                    
                    <!-- Market Notes -->
                    <div id="marketNotesSection" class="hidden">
                        <h4 class="font-semibold text-gray-900 mb-2">Market Notes</h4>
                        <p class="text-gray-700" id="marketNotes"></p>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="mt-6 flex justify-end">
                    <button onclick="closeFairPriceModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// Function to calculate luminance and determine appropriate text color
function calculateTextColor(hexColor) {
    // Remove # if present
    hexColor = hexColor.replace('#', '');
    
    // Parse hex to RGB
    const r = parseInt(hexColor.substr(0, 2), 16);
    const g = parseInt(hexColor.substr(2, 2), 16);
    const b = parseInt(hexColor.substr(4, 2), 16);
    
    // Calculate relative luminance using WCAG formula
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    
    // Return white for dark backgrounds, black for light backgrounds
    return luminance < 0.5 ? 'white' : 'black';
}

// Function to apply brand color styling
function applyBrandColorStyling() {
    document.querySelectorAll('[data-brand-color]').forEach(element => {
        const brandColor = element.getAttribute('data-brand-color');
        if (brandColor) {
            const textColor = calculateTextColor(brandColor);
            element.style.color = textColor;
        }
    });
}

// Category hierarchy filtering
function initializeCategoryFiltering() {
    const categoryLevel1 = document.getElementById('category_level1');
    const categoryLevel2 = document.getElementById('category_level2');
    const categoryLevel3 = document.getElementById('category_level3');
    
    if (categoryLevel1 && categoryLevel2 && categoryLevel3) {
        // Filter level 2 options based on level 1 selection
        categoryLevel1.addEventListener('change', function() {
            const selectedLevel1 = this.value;
            const level2Options = categoryLevel2.querySelectorAll('option[data-parent]');
            
            level2Options.forEach(option => {
                if (selectedLevel1 === '' || option.dataset.parent === selectedLevel1) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Reset level 2 and 3 selections if parent changed
            if (categoryLevel2.value && categoryLevel2.querySelector(`option[value="${categoryLevel2.value}"][data-parent="${selectedLevel1}"]`)) {
                // Keep current selection if it's still valid
            } else {
                categoryLevel2.value = '';
                categoryLevel3.value = '';
            }
            
            // Filter level 3 options
            filterLevel3Options();
            
            // Auto-submit form when category changes
            setTimeout(() => this.form.submit(), 10);
        });
        
        // Filter level 3 options based on level 2 selection
        categoryLevel2.addEventListener('change', function() {
            filterLevel3Options();
            
            // Auto-submit form when subcategory changes
            setTimeout(() => this.form.submit(), 10);
        });
        
        // Auto-submit form when product type changes
        categoryLevel3.addEventListener('change', function() {
            setTimeout(() => this.form.submit(), 10);
        });
        
        function filterLevel3Options() {
            const selectedLevel2 = categoryLevel2.value;
            const level3Options = categoryLevel3.querySelectorAll('option[data-parent]');
            
            level3Options.forEach(option => {
                if (selectedLevel2 === '' || option.dataset.parent === selectedLevel2) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Reset level 3 selection if parent changed
            if (categoryLevel3.value && categoryLevel3.querySelector(`option[value="${categoryLevel3.value}"][data-parent="${selectedLevel2}"]`)) {
                // Keep current selection if it's still valid
            } else {
                categoryLevel3.value = '';
            }
        }
        
        // Initialize filtering on page load without triggering events
        const selectedLevel1 = categoryLevel1.value;
        const level2Options = categoryLevel2.querySelectorAll('option[data-parent]');
        
        level2Options.forEach(option => {
            if (selectedLevel1 === '' || option.dataset.parent === selectedLevel1) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
        
        // Filter level 3 options
        const selectedLevel2 = categoryLevel2.value;
        const level3Options = categoryLevel3.querySelectorAll('option[data-parent]');
        
        level3Options.forEach(option => {
            if (selectedLevel2 === '' || option.dataset.parent === selectedLevel2) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
    }
}

// Collapsible sections
function initializeCollapsibleSections() {
    const sections = ['brand', 'voltage', 'platform', 'product_line', 'features', 'attributes'];
    
    sections.forEach(sectionId => {
        const header = document.getElementById(`${sectionId}-header`).parentElement;
        const content = document.getElementById(`${sectionId}-content`);
        const chevron = document.getElementById(`${sectionId}-chevron`);
        
        if (header && content && chevron) {
            // Initialize expanded state - remove any hidden classes but don't force display
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
            header.setAttribute('aria-expanded', 'true');
        }
    });
}

// Toggle section visibility
function toggleSection(sectionId) {
    const content = document.getElementById(`${sectionId}-content`);
    const chevron = document.getElementById(`${sectionId}-chevron`);
    const header = document.getElementById(`${sectionId}-header`).parentElement;
    
    if (content && chevron && header) {
        const isExpanded = header.getAttribute('aria-expanded') === 'true';
        
        if (isExpanded) {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
            header.setAttribute('aria-expanded', 'false');
        } else {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
            header.setAttribute('aria-expanded', 'true');
        }
    }
}

// Keyboard navigation for filter sections
function handleFilterKeydown(event, sectionId) {
    if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        toggleSection(sectionId);
    }
}

// Clear search function
function clearSearch() {
    document.getElementById('search-input').value = '';
    document.getElementById('filter-form').submit();
}

// Remove filter function
function removeFilter(filterType, value) {
    const form = document.getElementById('filter-form');
    const inputs = form.querySelectorAll(`input[name="${filterType}"]`);
    inputs.forEach(input => {
        if (input.value === value) {
            input.checked = false;
        }
    });
    form.submit();
}

// Global function to handle sort change
function handleSortChange(selectElement) {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Parse the sort value to extract field and direction
    const sortValue = selectElement.value;
    let sortField, sortDirection;
    
    if (sortValue.endsWith('_desc')) {
        sortField = sortValue.replace('_desc', '');
        sortDirection = 'desc';
    } else {
        sortField = sortValue;
        sortDirection = 'asc';
    }
    
    // Update the sort parameters
    urlParams.set('sort', sortField);
    urlParams.set('sort_direction', sortDirection);
    urlParams.set('page', '1'); // Reset to first page when sorting
    
    // Navigate to the new URL
    window.location.href = '?' + urlParams.toString();
}

// Global function to toggle sort direction
function toggleSortDirection() {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Toggle the sort direction
    const currentDirection = urlParams.get('sort_direction') || 'asc';
    const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
    
    // Update the sort direction parameter
    urlParams.set('sort_direction', newDirection);
    urlParams.set('page', '1'); // Reset to first page when changing direction
    
    // Navigate to the new URL
    window.location.href = '?' + urlParams.toString();
}

// Debounced search
function initializeDebouncedSearch() {
    const searchInput = document.getElementById('search-input');
    let timeoutId;
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                this.form.submit();
            }, 300);
        });
    }
}

// Fair Price Modal Functions
function openFairPriceModal(componentId) {
    const modal = document.getElementById('fairPriceModal');
    const nameElement = document.getElementById('componentName');
    const skuElement = document.getElementById('componentSku');
    const priceElement = document.getElementById('fairPrice');
    
    // Get data from hidden elements
    const name = document.getElementById(`component-${componentId}-name`).textContent;
    const sku = document.getElementById(`component-${componentId}-sku`).textContent;
    const fairPrice = document.getElementById(`component-${componentId}-fair-price`).textContent;
    const reasoning = document.getElementById(`component-${componentId}-reasoning`).textContent;
    const pros = document.getElementById(`component-${componentId}-pros`).textContent;
    const cons = document.getElementById(`component-${componentId}-cons`).textContent;
    const marketNotes = document.getElementById(`component-${componentId}-market-notes`).textContent;
    
    // Set component info
    nameElement.textContent = name;
    skuElement.textContent = sku ? `Model#: ${sku}` : '';
    
    // Set fair price
    if (fairPrice && !isNaN(parseFloat(fairPrice))) {
        const roundedPrice = Math.round(parseFloat(fairPrice));
        priceElement.textContent = `$${roundedPrice}`;
    } else {
        priceElement.textContent = 'Price analysis available';
    }
    
    // Show/hide and populate sections based on available data
    populateModalSection('reasoningSection', 'reasoning', reasoning);
    populateModalList('prosSection', 'prosList', pros ? pros.split('|||') : []);
    populateModalList('consSection', 'consList', cons ? cons.split('|||') : []);
    populateModalSection('marketNotesSection', 'marketNotes', marketNotes);
    
    // Show modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeFairPriceModal() {
    const modal = document.getElementById('fairPriceModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto'; // Restore scrolling
}

function populateModalSection(sectionId, elementId, data) {
    const section = document.getElementById(sectionId);
    const element = document.getElementById(elementId);
    
    if (data && data.trim()) {
        element.textContent = data;
        section.classList.remove('hidden');
    } else {
        section.classList.add('hidden');
    }
}

function populateModalList(sectionId, listId, data) {
    const section = document.getElementById(sectionId);
    const list = document.getElementById(listId);
    
    if (data && Array.isArray(data) && data.length > 0) {
        list.innerHTML = '';
        data.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            list.appendChild(li);
        });
        section.classList.remove('hidden');
    } else {
        section.classList.add('hidden');
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('fairPriceModal');
    if (event.target === modal) {
        closeFairPriceModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeFairPriceModal();
    }
});

// Quick Navigation Functions
function quickFilter(type, value) {
    const form = document.getElementById('filter-form');
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = type;
    input.value = value;
    form.appendChild(input);
    form.submit();
}

function toggleView(viewType) {
    const gridView = document.getElementById('grid-view');
    const listView = document.getElementById('list-view');
    const componentGrid = document.querySelector('.grid');
    
    if (viewType === 'grid') {
        gridView.classList.add('bg-white', 'shadow-sm', 'text-gray-700');
        gridView.classList.remove('text-gray-500');
        listView.classList.remove('bg-white', 'shadow-sm', 'text-gray-700');
        listView.classList.add('text-gray-500');
        
        if (componentGrid) {
            componentGrid.classList.remove('grid-cols-1');
            componentGrid.classList.add('grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
        }
    } else {
        listView.classList.add('bg-white', 'shadow-sm', 'text-gray-700');
        listView.classList.remove('text-gray-500');
        gridView.classList.remove('bg-white', 'shadow-sm', 'text-gray-700');
        gridView.classList.add('text-gray-500');
        
        if (componentGrid) {
            componentGrid.classList.remove('grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
            componentGrid.classList.add('grid-cols-1');
        }
    }
    
    // Save preference
    localStorage.setItem('viewType', viewType);
}

function changeResultsPerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('page_size', value);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

// Quick View and Compare Functions
function openQuickView(componentId) {
    // Show loading state
    const modal = document.getElementById('quickViewModal');
    const content = document.getElementById('quickViewContent');
    
    // Show modal with loading state
    modal.classList.remove('hidden');
    content.innerHTML = `
        <div class="flex items-center justify-center p-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600">Loading...</span>
        </div>
    `;
    
    // Fetch component data
    fetch(`/api/quick-info/${componentId}/?type=component`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                content.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-red-600">Error loading component details</p>
                    </div>
                `;
                return;
            }
            
            // Truncate description
            const description = data.description || '';
            const truncatedDesc = description.length > 500 ? description.substring(0, 500) + '...' : description;
            
            // Build key attributes display
            const keyAttributesHtml = data.key_attributes && data.key_attributes.length > 0
                ? `<div class="mb-4">
                     <span class="text-sm font-medium text-gray-700">Key Attributes:</span>
                     <div class="mt-2 border border-gray-200 rounded-lg overflow-hidden">
                       ${data.key_attributes.map((attr, index) => 
                           `<div class="flex justify-between items-center text-sm px-3 py-2 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} border-b border-gray-100 last:border-b-0">
                              <span class="font-medium text-gray-900">${attr.name}</span>
                              <span class="text-gray-700 bg-gray-100 px-2 py-1 rounded text-xs font-medium">${attr.value}${attr.unit ? ' ' + attr.unit : ''}</span>
                            </div>`
                       ).join('')}
                     </div>
                   </div>`
                : '';
            
            // Populate modal with component data
            content.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/2">
                        <div class="aspect-square bg-white rounded-lg overflow-hidden border">
                            ${data.image ? 
                                `<img src="${data.image}" alt="${data.name}" class="w-full h-full object-cover">` :
                                `<div class="w-full h-full flex items-center justify-center text-gray-400">
                                    <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>`
                            }
                        </div>
                    </div>
                    <div class="md:w-1/2">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                ${data.brand || 'Unknown Brand'}
                            </span>
                            ${data.sku ? `<span class="text-xs text-gray-500">Model#: ${data.sku}</span>` : ''}
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">${data.name}</h3>
                        ${keyAttributesHtml}
                        ${truncatedDesc ? `<p class="text-gray-700 mb-4">${truncatedDesc}</p>` : ''}
                        <div class="flex gap-2">
                            <a href="${data.url}" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg text-center hover:bg-blue-700 transition-colors">
                                View Full Details
                            </a>
                            <button onclick="closeQuickView()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            content.innerHTML = `
                <div class="text-center p-8">
                    <p class="text-red-600">Error loading component details</p>
                </div>
            `;
        });
}

function closeQuickView() {
    const modal = document.getElementById('quickViewModal');
    modal.classList.add('hidden');
}

function toggleCompare(checkbox) {
    const componentId = checkbox.dataset.componentId;
    const compareList = JSON.parse(localStorage.getItem('componentCompareList') || '[]');
    const checkboxContainer = document.getElementById(`compare-checkbox-${componentId}`);
    const checkmark = checkboxContainer.querySelector('.checkmark');
    const checkboxVisual = checkboxContainer.querySelector('.checkbox-visual');
    
    if (checkbox.checked) {
        if (compareList.length >= 4) {
            showToast('You can compare up to 4 components at once.', 'warning');
            checkbox.checked = false;
            return;
        }
        if (!compareList.includes(componentId)) {
            compareList.push(componentId);
        }
        // Show checkbox as checked
        checkboxVisual.classList.add('bg-blue-600', 'border-blue-600');
        checkmark.classList.remove('hidden');
        checkboxContainer.classList.remove('opacity-0');
        checkboxContainer.classList.add('opacity-100');
    } else {
        const index = compareList.indexOf(componentId);
        if (index > -1) {
            compareList.splice(index, 1);
        }
        // Show checkbox as unchecked
        checkboxVisual.classList.remove('bg-blue-600', 'border-blue-600');
        checkmark.classList.add('hidden');
        // Keep checkbox visible but with reduced opacity
        checkboxContainer.classList.remove('opacity-0');
        checkboxContainer.classList.add('opacity-100');
    }
    
    localStorage.setItem('componentCompareList', JSON.stringify(compareList));
    updateCompareButton();
}

function clearComparison() {
    const compareList = JSON.parse(localStorage.getItem('componentCompareList') || '[]');
    
    // Uncheck all checkboxes that exist in the current DOM
    compareList.forEach(componentId => {
        const checkbox = document.querySelector(`input[data-component-id="${componentId}"]`);
        if (checkbox) {
            checkbox.checked = false;
            const checkboxContainer = document.getElementById(`compare-checkbox-${componentId}`);
            if (checkboxContainer) {
            const checkmark = checkboxContainer.querySelector('.checkmark');
            const checkboxVisual = checkboxContainer.querySelector('.checkbox-visual');
            
                if (checkboxVisual) {
            checkboxVisual.classList.remove('bg-blue-600', 'border-blue-600');
                }
                if (checkmark) {
            checkmark.classList.add('hidden');
                }
            checkboxContainer.classList.add('opacity-0');
            checkboxContainer.classList.remove('opacity-100');
            }
        }
    });
    
    // Clear localStorage
    localStorage.setItem('componentCompareList', JSON.stringify([]));
    updateCompareButton();
}

function updateCompareButton() {
    const compareList = JSON.parse(localStorage.getItem('componentCompareList') || '[]');
    const compareButton = document.getElementById('compare-button');
    const clearButton = document.getElementById('clear-compare-button');
    
    if (compareButton) {
        compareButton.textContent = `Compare (${compareList.length})`;
        compareButton.disabled = compareList.length < 2;
        if (clearButton) {
            if (compareList.length > 0) {
                clearButton.classList.remove('hidden');
            } else {
                clearButton.classList.add('hidden');
            }
        }
    }
}

function openCompareModal() {
    const compareList = JSON.parse(localStorage.getItem('componentCompareList') || '[]');
    if (compareList.length < 2) {
        showToast('Please select at least 2 components to compare', 'warning');
        return;
    }
    
    // Show loading indicator
    showLoading('Loading comparison...');
    
    // Make AJAX call to get comparison data
    fetch(`/api/compare-components/?component_ids=${compareList.join(',')}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.error) {
                showToast(data.error, 'error');
                return;
            }
            buildComparisonModal(data);
        })
        .catch(error => {
            hideLoading();
            console.error('Error loading comparison:', error);
            showToast('Error loading comparison data', 'error');
        });
}

function buildComparisonModal(data) {
    const modal = document.getElementById('comparison-modal');
    const content = document.getElementById('comparison-content');
    
    // Clear previous content
    content.innerHTML = '';
    
    // Update modal title
    const modalTitle = modal.querySelector('h2');
    if (modalTitle) {
        modalTitle.textContent = `Compare Components (${data.components.length})`;
    }
    
    // Create comparison table
    const table = document.createElement('div');
    table.className = 'overflow-x-auto';
    
    // Build table HTML
    let tableHTML = `
        <div class="comparison-table-desktop">
            <table class="comparison-table min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Specification</th>
                        ${data.components.map(comp => `
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-48">
                                <div class="flex flex-col items-center space-y-2">
                                    <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden">
                                        ${comp.image ? 
                                            `<img src="${comp.image}" alt="${comp.name}" class="w-full h-full object-cover">` : 
                                            `<svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>`
                                        }
                                    </div>
                                    <div class="text-center">
                                        <div class="font-semibold text-gray-900 text-sm">${comp.name}</div>
                                        <div class="text-xs text-gray-500">${comp.brand}</div>
                                        ${comp.sku ? `<div class="text-xs text-gray-400">Model#: ${comp.sku}</div>` : ''}
                                    </div>
                                    <div class="flex space-x-1">
                                        <a href="/components/${comp.id}/" class="text-blue-600 hover:text-blue-800 text-xs">View Details</a>
                                        <button onclick="removeFromComparison('${comp.id}')" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
                                    </div>
                                </div>
                            </th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;
    
    // Basic Information Section
    tableHTML += `
        <tr class="bg-blue-50">
            <td colspan="${data.components.length + 1}" class="px-4 py-2 text-sm font-semibold text-blue-900">Basic Information</td>
        </tr>
    `;
    
    // Brand
    tableHTML += buildComparisonRow('Brand', data.components.map(comp => comp.brand || 'N/A'), 'text');
    
    // SKU
    tableHTML += buildComparisonRow('SKU', data.components.map(comp => comp.sku || 'N/A'), 'text');
    
    // Product Lines
    tableHTML += buildComparisonRow('Product Line', data.components.map(comp => comp.product_lines.join(', ') || 'N/A'), 'text');
    
    // Voltage
    tableHTML += buildComparisonRow('Voltage', data.components.map(comp => comp.voltage.join(', ') + 'V' || 'N/A'), 'text');
    
    // Platform
    tableHTML += buildComparisonRow('Platform', data.components.map(comp => comp.platform.join(', ') || 'N/A'), 'text');
    
    // Categories
    tableHTML += buildComparisonRow('Categories', data.components.map(comp => comp.categories.join(', ') || 'N/A'), 'text');
    
    // Key Specifications Section
    if (data.common_attributes.filter(attr => attr.type === 'important').length > 0) {
        tableHTML += `
            <tr class="bg-green-50">
                <td colspan="${data.components.length + 1}" class="px-4 py-2 text-sm font-semibold text-green-900">Key Specifications</td>
            </tr>
        `;
        
        data.common_attributes
            .filter(attr => attr.type === 'important')
            .forEach(attr => {
                const values = data.components.map(comp => {
                    const attrData = comp.important_attributes[attr.name];
                    return attrData ? `${attrData.value}${attrData.unit ? ' ' + attrData.unit : ''}` : 'N/A';
                });
                tableHTML += buildComparisonRow(attr.name, values, 'spec');
            });
    }
    
    // Additional Specifications Section
    if (data.common_attributes.filter(attr => attr.type === 'additional').length > 0) {
        tableHTML += `
            <tr class="bg-gray-50">
                <td colspan="${data.components.length + 1}" class="px-4 py-2 text-sm font-semibold text-gray-900">Additional Specifications</td>
            </tr>
        `;
        
        data.common_attributes
            .filter(attr => attr.type === 'additional')
            .forEach(attr => {
                const values = data.components.map(comp => {
                    const attrData = comp.additional_attributes[attr.name];
                    return attrData ? `${attrData.value}${attrData.unit ? ' ' + attrData.unit : ''}` : 'N/A';
                });
                tableHTML += buildComparisonRow(attr.name, values, 'spec');
            });
    }
    
    // Fair Price Section (if enabled)
    if (data.show_fair_price && data.components.some(comp => comp.fair_price !== null)) {
        tableHTML += `
            <tr class="bg-gray-50">
                <td colspan="${data.components.length + 1}" class="px-4 py-2 text-sm font-semibold text-gray-900">Fair Price Analysis</td>
            </tr>
        `;
        
        // Fair Price
        tableHTML += buildComparisonRow('Fair Price', data.components.map(comp => {
            if (comp.fair_price && comp.fair_price.price) {
                return `$${Math.round(comp.fair_price.price)}`;
            }
            return '<span class="text-gray-400 italic">Value Guide Available</span>';
        }), 'price');
        
        // Reasoning
        tableHTML += buildComparisonRow('Reasoning', data.components.map(comp => {
            if (comp.fair_price && comp.fair_price.reasoning) {
                return comp.fair_price.reasoning;
            }
            return '<span class="text-gray-400 italic">Value Guide Available</span>';
        }), 'text');
    }
    
    tableHTML += `
                </tbody>
            </table>
        </div>
        
        <!-- Mobile View -->
        <div class="comparison-table-mobile">
            ${data.components.map(comp => `
                <div class="comparison-card">
                    <div class="comparison-card-header">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden">
                                ${comp.image ? 
                                    `<img src="${comp.image}" alt="${comp.name}" class="w-full h-full object-cover">` : 
                                    `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>`
                                }
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900">${comp.name}</h3>
                                <p class="text-sm text-gray-500">${comp.brand}</p>
                                ${comp.sku ? `<p class="text-xs text-gray-400">Model#: ${comp.sku}</p>` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <a href="/components/${comp.id}/" class="text-blue-600 hover:text-blue-800 text-sm">View</a>
                                <button onclick="removeFromComparison('${comp.id}')" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                            </div>
                        </div>
                    </div>
                    <div class="comparison-card-body">
                        ${buildMobileComparisonContent(comp, data)}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    table.innerHTML = tableHTML;
    content.appendChild(table);
    
    // Show modal
    modal.classList.remove('hidden');
}

function buildComparisonRow(label, values, type = 'text') {
    // Check if all values are the same
    const allSame = values.every(val => val === values[0]);
    
    return `
        <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-medium text-gray-900 border-r border-gray-200">${label}</td>
            ${values.map((value, index) => {
                const cellClass = allSame ? 'text-gray-900' : 'text-gray-900 highlight-difference';
                const valueClass = type === 'price' ? 'price-value' : 
                                 type === 'spec' ? 'spec-value' : 'text-sm';
                return `
                    <td class="px-4 py-3 ${cellClass}">
                        <span class="${valueClass}">${value}</span>
                    </td>
                `;
            }).join('')}
        </tr>
    `;
}

function buildMobileComparisonContent(component, data) {
    let content = '';
    
    // Basic Information
    content += '<div class="mb-4">';
    content += '<h4 class="text-sm font-semibold text-gray-900 mb-2">Basic Information</h4>';
    content += buildMobileSpecRow('Brand', component.brand || 'N/A');
    content += buildMobileSpecRow('SKU', component.sku || 'N/A');
    content += buildMobileSpecRow('Product Line', component.product_lines.join(', ') || 'N/A');
    content += buildMobileSpecRow('Voltage', component.voltage.join(', ') + 'V' || 'N/A');
    content += buildMobileSpecRow('Platform', component.platform.join(', ') || 'N/A');
    content += buildMobileSpecRow('Categories', component.categories.join(', ') || 'N/A');
    content += '</div>';
    
    // Key Specifications
    const importantAttrs = data.common_attributes.filter(attr => attr.type === 'important');
    if (importantAttrs.length > 0) {
        content += '<div class="mb-4">';
        content += '<h4 class="text-sm font-semibold text-gray-900 mb-2">Key Specifications</h4>';
        importantAttrs.forEach(attr => {
            const attrData = component.important_attributes[attr.name];
            const value = attrData ? `${attrData.value}${attrData.unit ? ' ' + attrData.unit : ''}` : 'N/A';
            content += buildMobileSpecRow(attr.name, value);
        });
        content += '</div>';
    }
    
    // Additional Specifications
    const additionalAttrs = data.common_attributes.filter(attr => attr.type === 'additional');
    if (additionalAttrs.length > 0) {
        content += '<div class="mb-4">';
        content += '<h4 class="text-sm font-semibold text-gray-900 mb-2">Additional Specifications</h4>';
        additionalAttrs.forEach(attr => {
            const attrData = component.additional_attributes[attr.name];
            const value = attrData ? `${attrData.value}${attrData.unit ? ' ' + attrData.unit : ''}` : 'N/A';
            content += buildMobileSpecRow(attr.name, value);
        });
        content += '</div>';
    }
    
    // Fair Price (if enabled and available)
    if (data.show_fair_price && component.fair_price !== null) {
        content += '<div class="mb-4">';
        content += '<h4 class="text-sm font-semibold text-gray-900 mb-2">Fair Price Analysis</h4>';
        
        if (component.fair_price && component.fair_price.price) {
            content += buildMobileSpecRow('Fair Price', `$${Math.round(component.fair_price.price)}`, 'price');
        } else {
            content += buildMobileSpecRow('Fair Price', '<span class="text-gray-400 italic">Value Guide Available</span>', 'price');
        }
        
        if (component.fair_price && component.fair_price.reasoning) {
            content += buildMobileSpecRow('Reasoning', component.fair_price.reasoning || 'N/A');
        } else {
            content += buildMobileSpecRow('Reasoning', '<span class="text-gray-400 italic">Value Guide Available</span>');
        }
        
        content += '</div>';
    }
    
    return content;
}

function buildMobileSpecRow(label, value, type = 'text') {
    const valueClass = type === 'price' ? 'price-value' : 'text-sm';
    return `
        <div class="comparison-spec-row">
            <span class="comparison-spec-label">${label}</span>
            <span class="comparison-spec-value ${valueClass}">${value}</span>
        </div>
    `;
}

function removeFromComparison(componentId) {
    const compareList = JSON.parse(localStorage.getItem('componentCompareList') || '[]');
    const index = compareList.indexOf(componentId);
    if (index > -1) {
        compareList.splice(index, 1);
        localStorage.setItem('componentCompareList', JSON.stringify(compareList));
        
        // Update UI
        const checkbox = document.querySelector(`input[data-component-id="${componentId}"]`);
        if (checkbox) {
            checkbox.checked = false;
            const checkboxContainer = document.getElementById(`compare-checkbox-${componentId}`);
            if (checkboxContainer) {
                const checkmark = checkboxContainer.querySelector('.checkmark');
                const checkboxVisual = checkboxContainer.querySelector('.checkbox-visual');
                
                if (checkboxVisual) {
                    checkboxVisual.classList.remove('bg-blue-600', 'border-blue-600');
                }
                if (checkmark) {
                    checkmark.classList.add('hidden');
                }
                checkboxContainer.classList.add('opacity-0');
                checkboxContainer.classList.remove('opacity-100');
            }
        }
        
        updateCompareButton();
        
        // If less than 2 components, close modal
        if (compareList.length < 2) {
            closeComparisonModal();
            showToast('Need at least 2 components to compare', 'warning');
        } else {
            // Refresh comparison
            openCompareModal();
        }
    }
}

function closeComparisonModal() {
    const modal = document.getElementById('comparison-modal');
    modal.classList.add('hidden');
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Apply brand color styling
    applyBrandColorStyling();
    
    initializeCategoryFiltering();
    initializeCollapsibleSections();
    initializeDebouncedSearch();
    
    // Initialize view type from localStorage
    const savedViewType = localStorage.getItem('viewType') || 'grid';
    toggleView(savedViewType);
    
    // Initialize compare button state from localStorage
    updateCompareButton();
    
    // Initialize compare state on page load
    const compareList = JSON.parse(localStorage.getItem('componentCompareList') || '[]');
    const validComponentIds = [];
    
    // Initialize all checkboxes to unchecked state first
    document.querySelectorAll('.compare-checkbox').forEach(checkbox => {
        const componentId = checkbox.dataset.componentId;
        const checkboxContainer = document.getElementById(`compare-checkbox-${componentId}`);
        if (checkboxContainer) {
            const checkmark = checkboxContainer.querySelector('.checkmark');
            const checkboxVisual = checkboxContainer.querySelector('.checkbox-visual');
            
            // Set to unchecked state
            checkbox.checked = false;
            if (checkboxVisual) {
                checkboxVisual.classList.remove('bg-blue-600', 'border-blue-600');
            }
            if (checkmark) {
                checkmark.classList.add('hidden');
            }
            checkboxContainer.classList.remove('opacity-0');
            checkboxContainer.classList.add('opacity-100');
        }
    });
    
    // Then restore checked state for components in compare list
    compareList.forEach(componentId => {
        const checkbox = document.querySelector(`input[data-component-id="${componentId}"]`);
        if (checkbox) {
            // Component is visible in current view, restore its state
            checkbox.checked = true;
            const checkboxContainer = document.getElementById(`compare-checkbox-${componentId}`);
            if (checkboxContainer) {
                const checkmark = checkboxContainer.querySelector('.checkmark');
                const checkboxVisual = checkboxContainer.querySelector('.checkbox-visual');
                
                if (checkboxVisual) {
                    checkboxVisual.classList.add('bg-blue-600', 'border-blue-600');
                }
                if (checkmark) {
                    checkmark.classList.remove('hidden');
                }
                checkboxContainer.classList.remove('opacity-0');
                checkboxContainer.classList.add('opacity-100');
            }
            validComponentIds.push(componentId);
        }
    });
    
    // Update localStorage to only include components that are currently visible
    if (validComponentIds.length !== compareList.length) {
        localStorage.setItem('componentCompareList', JSON.stringify(validComponentIds));
    }
    
    updateCompareButton();
    
    // Initialize global comparison button
    if (typeof updateComparisonButton === 'function') {
        updateComparisonButton();
    }
});
    </script>
{% endblock %}
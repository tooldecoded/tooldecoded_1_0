{% extends 'frontend/base.html' %}

{% block content %}
<div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Filters Sidebar -->
            <div class="lg:w-1/4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-md font-semibold text-gray-900 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                        </svg>
                        Filters
                    </h2>
                        {% if current_filters.search or current_filters.brand or current_filters.voltage or current_filters.platform or current_filters.category_level1 or current_filters.category_level2 or current_filters.category_level3 or current_filters.product_line or selected_attribute_filters or selected_feature_filters %}
                            <a href="?" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                Clear All
                            </a>
                        {% endif %}
                    </div>
                    
                    <!-- Active Filters -->
                    {% if current_filters.search or current_filters.brand or current_filters.voltage or current_filters.platform or current_filters.category_level1 or current_filters.category_level2 or current_filters.category_level3 or current_filters.product_line or selected_attribute_filters or selected_feature_filters %}
                    <div class="mb-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Active Filters</h3>
                        <div class="flex flex-wrap gap-2" id="activeFilters">
                            {% if current_filters.search %}
                                <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                    Search: {{ current_filters.search }}
                                    <button type="button" onclick="clearSearch()" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                </span>
                            {% endif %}
                            
                            {% for brand in brands %}
                                {% if brand.id|stringformat:"s" in selected_brand_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ brand.name }}
                                        <button type="button" onclick="removeFilter('brand', '{{ brand.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            {% for voltage in voltages %}
                                {% if voltage.id|stringformat:"s" in selected_voltage_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ voltage.value }}V
                                        <button type="button" onclick="removeFilter('voltage', '{{ voltage.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            {% for platform in platforms %}
                                {% if platform.id|stringformat:"s" in selected_platform_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ platform.name }}
                                        <button type="button" onclick="removeFilter('platform', '{{ platform.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            {% for product_line in product_lines %}
                                {% if product_line.id|stringformat:"s" in selected_product_line_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ product_line.name }}
                                        <button type="button" onclick="removeFilter('product_line', '{{ product_line.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            {% for feature in features %}
                                {% if feature.id in selected_feature_filters %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">
                                        {{ feature.name }}
                                        <button type="button" onclick="removeFilter('feature_{{ feature.id }}', 'Yes')" class="ml-1 text-green-600 hover:text-green-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <form method="get" id="filter-form">
                        <!-- Search -->
                        <div class="filter-section mb-2 bg-gray-50 p-2 rounded-lg">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                                <div class="relative">
                                    <input type="text" name="search" value="{{ current_filters.search }}" 
                                           placeholder="Search components..." 
                                           class="w-full px-3 py-2 pl-10 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           id="search-input">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    </div>
                                    {% if current_filters.search %}
                                        <button type="button" onclick="clearSearch()" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                            <svg class="h-4 w-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Category Filters -->
                        <div class="filter-section mb-6 bg-gray-50 p-4 rounded-lg">
                            <div class="space-y-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                    <select name="category_level1" id="category_level1" class="w-full px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">All Categories</option>
                                        {% for category in level1_categories %}
                                            <option value="{{ category.id }}" {% if current_filters.category_level1 == category.id|stringformat:"s" %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <!--<label class="block text-sm font-medium text-gray-700 mb-1">Subcategory</label>-->
                                    <select name="category_level2" id="category_level2" class="w-full px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">All Subcategories</option>
                                        {% for category in level2_categories_with_parent %}
                                            <option value="{{ category.id }}" data-parent="{{ category.parent }}" {% if current_filters.category_level2 == category.id|stringformat:"s" %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <!--<label class="block text-sm font-medium text-gray-700 mb-1">Product Type</label>-->
                                    <select name="category_level3" id="category_level3" class="w-full px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">All Product Types</option>
                                        {% for category in level3_categories_with_parent %}
                                            <option value="{{ category.id }}" data-parent="{{ category.parent }}" {% if current_filters.category_level3 == category.id|stringformat:"s" %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>


                        <!-- Brand Filter -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('brand')" 
                                    aria-expanded="true" 
                                    aria-controls="brand-content"
                                    aria-labelledby="brand-header"
                                    onkeydown="handleFilterKeydown(event, 'brand')" tabindex="0">
                                <span id="brand-header" class="text-sm font-medium text-gray-700">
                                    Brand
                                    {% if filter_counts.brands.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.brands.selected }}/{{ filter_counts.brands.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="brand-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="brand-content" class="mt-2" role="region" aria-labelledby="brand-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Brand filter options">
                                    {% for brand in brands %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="brand_{{ brand.id }}">
                                            <input type="checkbox" name="brand" value="{{ brand.id }}" 
                                                       {% if brand.id|stringformat:"s" in selected_brand_ids %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="brand_{{ brand.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ brand.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Voltage Filter -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('voltage')" 
                                    aria-expanded="true" 
                                    aria-controls="voltage-content"
                                    aria-labelledby="voltage-header"
                                    onkeydown="handleFilterKeydown(event, 'voltage')" tabindex="0">
                                <span id="voltage-header" class="text-sm font-medium text-gray-700">
                                    Voltage
                                    {% if filter_counts.voltages.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.voltages.selected }}/{{ filter_counts.voltages.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="voltage-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="voltage-content" class="mt-2" role="region" aria-labelledby="voltage-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Voltage filter options">
                                    {% for voltage in voltages %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="voltage_{{ voltage.id }}">
                                            <input type="checkbox" name="voltage" value="{{ voltage.id }}" 
                                                   {% if voltage.id|stringformat:"s" in selected_voltage_ids %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="voltage_{{ voltage.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ voltage.value }}V</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Platform Filter -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('platform')" 
                                    aria-expanded="true" 
                                    aria-controls="platform-content"
                                    aria-labelledby="platform-header"
                                    onkeydown="handleFilterKeydown(event, 'platform')" tabindex="0">
                                <span id="platform-header" class="text-sm font-medium text-gray-700">
                                    Platform
                                    {% if filter_counts.platforms.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.platforms.selected }}/{{ filter_counts.platforms.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="platform-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="platform-content" class="mt-2" role="region" aria-labelledby="platform-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Platform filter options">
                                    {% for platform in platforms %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="platform_{{ platform.id }}">
                                            <input type="checkbox" name="platform" value="{{ platform.id }}" 
                                                   {% if platform.id|stringformat:"s" in selected_platform_ids %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="platform_{{ platform.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ platform.name }}</span>
                                                    </label>
                                                {% endfor %}
                                            </div>
                            </div>
                        </div>

                        <!-- Product Lines Filter -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('product_line')" 
                                    aria-expanded="true" 
                                    aria-controls="product_line-content"
                                    aria-labelledby="product_line-header"
                                    onkeydown="handleFilterKeydown(event, 'product_line')" tabindex="0">
                                <span id="product_line-header" class="text-sm font-medium text-gray-700">
                                    Product Lines
                                    {% if filter_counts.product_lines.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.product_lines.selected }}/{{ filter_counts.product_lines.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="product_line-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="product_line-content" class="mt-2" role="region" aria-labelledby="product_line-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Product Lines filter options">
                                    {% for product_line in product_lines %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="product_line_{{ product_line.id }}">
                                            <input type="checkbox" name="product_line" value="{{ product_line.id }}" 
                                                   {% if product_line.id|stringformat:"s" in selected_product_line_ids %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="product_line_{{ product_line.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ product_line.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Features Filter -->
                        {% if features %}
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('features')" 
                                    aria-expanded="true" 
                                    aria-controls="features-content"
                                    aria-labelledby="features-header"
                                    onkeydown="handleFilterKeydown(event, 'features')" tabindex="0">
                                <span id="features-header" class="text-sm font-medium text-gray-700">Features</span>
                                <svg class="w-4 h-4 transform transition-transform" id="features-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="features-content" class="mt-2" role="region" aria-labelledby="features-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Features filter options">
                                    {% for feature in features %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="feature_{{ feature.id }}">
                                            <input type="checkbox" name="feature_{{ feature.id }}" value="Yes" 
                                                   {% if feature.id in selected_feature_filters %}checked{% endif %}
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                   id="feature_{{ feature.id }}">
                                            <span class="ml-2 text-sm text-gray-700">{{ feature.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Technical Attributes Filter -->
                        {% if attributes %}
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="flex items-center justify-between w-full text-left" 
                                    onclick="toggleSection('attributes')" 
                                    aria-expanded="true" 
                                    aria-controls="attributes-content"
                                    aria-labelledby="attributes-header"
                                    onkeydown="handleFilterKeydown(event, 'attributes')" tabindex="0">
                                <span id="attributes-header" class="text-sm font-medium text-gray-700">Technical Attributes</span>
                                <svg class="w-4 h-4 transform transition-transform" id="attributes-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="attributes-content" class="mt-2 space-y-4" role="region" aria-labelledby="attributes-header">
                                {% for attr in attributes %}
                                    <div>
                                        <h4 class="text-sm font-medium text-gray-700 mb-2">{{ attr.name }}{% if attr.unit %} ({{ attr.unit }}){% endif %}</h4>
                                        <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2">
                                            {% for value in attr.values %}
                                                <label class="flex items-center mb-1">
                                                    <input type="checkbox" name="attr_{{ attr.id }}" value="{{ value }}" 
                                                           {% if attr.id in selected_attribute_filters and value in selected_attribute_filters|default:"" %}checked{% endif %}
                                                           onchange="setTimeout(() => this.form.submit(), 10)"
                                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                    <span class="ml-2 text-sm text-gray-700">{{ value }}</span>
                                                </label>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- Main Content -->
            <div class="lg:w-3/4">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">
                        {% if components %}
                            Showing {{ components.start_index }}-{{ components.end_index }} of {{ components.paginator.count }} components
                        {% else %}
                            No components found
                        {% endif %}
                    </h2>
                    
                    <!-- Sort Dropdown -->
                    <div class="flex items-center space-x-2">
                        <label for="sortSelect" class="text-sm font-medium text-gray-700">Sort by:</label>
                        <select id="sortSelect" name="sort" class="px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" onchange="handleSortChange(this)">
                            <option value="name" {% if current_filters.sort == 'name' %}selected{% endif %}>Name</option>
                            <option value="brand" {% if current_filters.sort == 'brand' %}selected{% endif %}>Brand</option>
                            <option value="voltage" {% if current_filters.sort == 'voltage' %}selected{% endif %}>Voltage</option>
                        </select>
                    </div>
                </div>

                {% if components %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {% for component in components %}
                            <div class="bg-white rounded-xl shadow-sm border group flex flex-col">
                                <a href="{% url 'component_detail' component.id %}">
                                    <div class="aspect-square bg-white rounded-t-xl overflow-hidden">
                                        {% if component.image %}
                                            <img src="{{ component.image }}" alt="{{ component.name }}" class="w-full h-full object-contain p-2">
                                        {% else %}
                                            <div class="w-full h-full flex items-center justify-center text-gray-400">
                                                <div class="text-center">
                                                    <svg class="w-16 h-16 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                                </svg>
                                                <p class="text-sm">No Image</p>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </a>
                                <div class="p-5 flex flex-col flex-grow">
                                    <div class="mb-3">
                                        <h3 class="font-semibold text-gray-900 line-clamp-2 leading-tight mb-2">{{ component.name }}</h3>
                                    </div>
                                    <div class="space-y-2 mb-4">
                                        {% if component.brand %}
                                            <div class="text-sm">
                                                <span class="font-semibold text-gray-900">{{ component.brand.name }}</span>
                                            </div>
                                        {% endif %}
                                        {% if component.sku %}
                                            <div class="flex items-center text-sm text-gray-600">
                                                <span class="font-medium w-16">Model#:</span>
                                                <span class="font-mono">{{ component.sku }}</span>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Fair Price Badge -->
                                        {% if component.fair_price_narrative %}
                                            <div class="mt-2">
                                                <!-- Hidden data elements for this component -->
                                                <div id="component-{{ component.id }}-data" style="display: none;">
                                                    <span id="component-{{ component.id }}-name">{{ component.name }}</span>
                                                    <span id="component-{{ component.id }}-sku">{{ component.sku|default:"" }}</span>
                                                    <span id="component-{{ component.id }}-fair-price">{{ component.fair_price_narrative.fair_price|default:"" }}</span>
                                                    <span id="component-{{ component.id }}-reasoning">{{ component.fair_price_narrative.reasoning|default:"" }}</span>
                                                    <span id="component-{{ component.id }}-pros">{{ component.fair_price_narrative.pros|join:"|||" }}</span>
                                                    <span id="component-{{ component.id }}-cons">{{ component.fair_price_narrative.cons|join:"|||" }}</span>
                                                    <span id="component-{{ component.id }}-market-notes">{{ component.fair_price_narrative.market_notes|default:"" }}</span>
                                                </div>
                                                <button onclick="openFairPriceModal('{{ component.id }}')" 
                                                        class="inline-flex items-center px-2 py-1 text-xs font-medium bg-emerald-50 text-emerald-700 rounded-full hover:bg-emerald-100 transition-colors">
                                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                    </svg>
                                                    {% if component.fair_price_narrative.fair_price %}
                                                        {% if component.fair_price_narrative.fair_price|add:0 %}
                                                            Fair Value: ${{ component.fair_price_narrative.fair_price|floatformat:0 }}
                                                        {% else %}
                                                            Value Guide Available
                                                        {% endif %}
                                                    {% else %}
                                                        Value Guide Available
                                                    {% endif %}
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="mt-auto">
                                        <a href="{% url 'component_detail' component.id %}" class="block w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg text-sm font-medium hover:bg-blue-700 text-center">
                                        View Details
                                    </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if components.has_other_pages %}
                        <div class="mt-8 flex justify-between items-center">
                            <!-- Viewing info -->
                            <div class="text-sm text-gray-600">
                                Viewing <span class="font-semibold">{{ components.start_index }}-{{ components.end_index }}</span> of <span class="font-semibold">{{ components.paginator.count }}</span>
                            </div>
                            
                            <!-- Pagination controls -->
                            <nav class="flex items-center gap-2">
                                <!-- Previous arrow -->
                                {% if components.has_previous %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ components.previous_page_number }}" 
                                       class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-xl">
                                        <
                                    </a>
                                {% else %}
                                    <span class="text-gray-300 text-xl"></span>
                                {% endif %}

                                <!-- Page numbers -->
                                {% for num in components.paginator.page_range %}
                                    {% if num == components.number %}
                                        <span class="font-semibold text-gray-900 border-b-2 border-orange-500 text-md">{{ num }}</span>
                                    {% elif num >= components.number|add:'-2' and num <= components.number|add:'2' or components.number <= 3 and num <= 5 %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                    {% elif num == 1 and components.number > 4 %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                        <span class="text-gray-400 text-sm">...</span>
                                    {% elif num == components.paginator.num_pages and components.number < components.paginator.num_pages|add:'-3' %}
                                        <span class="text-gray-400 text-sm">...</span>
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                    {% endif %}
                                {% endfor %}

                                <!-- Next arrow -->
                                {% if components.has_next %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ components.next_page_number }}" 
                                       class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-xl">
                                        >
                                    </a>
                                {% else %}
                                    <span class="text-gray-300 text-xl"></span>
                                {% endif %}

                            </nav>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-12">
                        <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.824-2.491"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No components found</h3>
                        <p class="text-gray-500">Try adjusting your filters or search terms.</p>
                    </div>
                {% endif %}
            </div>
            </div>
        </div>
    </div>

    <!-- Fair Price Modal -->
    <div id="fairPriceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900" id="modalTitle">Fair Value Analysis</h3>
                    <button onclick="closeFairPriceModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="space-y-4" id="modalContent">
                    <!-- Component Info -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-900" id="componentName"></h4>
                        <p class="text-sm text-gray-600" id="componentSku"></p>
                    </div>
                    
                    <!-- Fair Price -->
                    <div class="bg-emerald-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-emerald-900 mb-2">Fair Value Price</h4>
                        <p class="text-2xl font-bold text-emerald-700" id="fairPrice"></p>
                    </div>
                    
                    <!-- Reasoning -->
                    <div id="reasoningSection" class="hidden">
                        <h4 class="font-semibold text-gray-900 mb-2">Analysis</h4>
                        <p class="text-gray-700" id="reasoning"></p>
                    </div>
                    
                    <!-- Pros -->
                    <div id="prosSection" class="hidden">
                        <h4 class="font-semibold text-green-900 mb-2">Pros</h4>
                        <ul class="list-disc list-inside text-gray-700 space-y-1" id="prosList"></ul>
                    </div>
                    
                    <!-- Cons -->
                    <div id="consSection" class="hidden">
                        <h4 class="font-semibold text-red-900 mb-2">Cons</h4>
                        <ul class="list-disc list-inside text-gray-700 space-y-1" id="consList"></ul>
                    </div>
                    
                    <!-- Market Notes -->
                    <div id="marketNotesSection" class="hidden">
                        <h4 class="font-semibold text-gray-900 mb-2">Market Notes</h4>
                        <p class="text-gray-700" id="marketNotes"></p>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="mt-6 flex justify-end">
                    <button onclick="closeFairPriceModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// Category hierarchy filtering
function initializeCategoryFiltering() {
    const categoryLevel1 = document.getElementById('category_level1');
    const categoryLevel2 = document.getElementById('category_level2');
    const categoryLevel3 = document.getElementById('category_level3');
    
    if (categoryLevel1 && categoryLevel2 && categoryLevel3) {
        // Filter level 2 options based on level 1 selection
        categoryLevel1.addEventListener('change', function() {
            const selectedLevel1 = this.value;
            const level2Options = categoryLevel2.querySelectorAll('option[data-parent]');
            
            level2Options.forEach(option => {
                if (selectedLevel1 === '' || option.dataset.parent === selectedLevel1) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Reset level 2 and 3 selections if parent changed
            if (categoryLevel2.value && categoryLevel2.querySelector(`option[value="${categoryLevel2.value}"][data-parent="${selectedLevel1}"]`)) {
                // Keep current selection if it's still valid
            } else {
                categoryLevel2.value = '';
                categoryLevel3.value = '';
            }
            
            // Filter level 3 options
            filterLevel3Options();
            
            // Auto-submit form when category changes
            setTimeout(() => this.form.submit(), 10);
        });
        
        // Filter level 3 options based on level 2 selection
        categoryLevel2.addEventListener('change', function() {
            filterLevel3Options();
            
            // Auto-submit form when subcategory changes
            setTimeout(() => this.form.submit(), 10);
        });
        
        // Auto-submit form when product type changes
        categoryLevel3.addEventListener('change', function() {
            setTimeout(() => this.form.submit(), 10);
        });
        
        function filterLevel3Options() {
            const selectedLevel2 = categoryLevel2.value;
            const level3Options = categoryLevel3.querySelectorAll('option[data-parent]');
            
            level3Options.forEach(option => {
                if (selectedLevel2 === '' || option.dataset.parent === selectedLevel2) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Reset level 3 selection if parent changed
            if (categoryLevel3.value && categoryLevel3.querySelector(`option[value="${categoryLevel3.value}"][data-parent="${selectedLevel2}"]`)) {
                // Keep current selection if it's still valid
            } else {
                categoryLevel3.value = '';
            }
        }
        
        // Initialize filtering on page load without triggering events
        const selectedLevel1 = categoryLevel1.value;
        const level2Options = categoryLevel2.querySelectorAll('option[data-parent]');
        
        level2Options.forEach(option => {
            if (selectedLevel1 === '' || option.dataset.parent === selectedLevel1) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
        
        // Filter level 3 options
        const selectedLevel2 = categoryLevel2.value;
        const level3Options = categoryLevel3.querySelectorAll('option[data-parent]');
        
        level3Options.forEach(option => {
            if (selectedLevel2 === '' || option.dataset.parent === selectedLevel2) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
    }
}

// Collapsible sections
function initializeCollapsibleSections() {
    const sections = ['brand', 'voltage', 'platform', 'product_line', 'features', 'attributes'];
    
    sections.forEach(sectionId => {
        const header = document.getElementById(`${sectionId}-header`).parentElement;
        const content = document.getElementById(`${sectionId}-content`);
        const chevron = document.getElementById(`${sectionId}-chevron`);
        
        if (header && content && chevron) {
            // Initialize expanded state - remove any hidden classes but don't force display
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
            header.setAttribute('aria-expanded', 'true');
        }
    });
}

// Toggle section visibility
function toggleSection(sectionId) {
    const content = document.getElementById(`${sectionId}-content`);
    const chevron = document.getElementById(`${sectionId}-chevron`);
    const header = document.getElementById(`${sectionId}-header`).parentElement;
    
    if (content && chevron && header) {
        const isExpanded = header.getAttribute('aria-expanded') === 'true';
        
        if (isExpanded) {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
            header.setAttribute('aria-expanded', 'false');
        } else {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
            header.setAttribute('aria-expanded', 'true');
        }
    }
}

// Keyboard navigation for filter sections
function handleFilterKeydown(event, sectionId) {
    if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        toggleSection(sectionId);
    }
}

// Clear search function
function clearSearch() {
    document.getElementById('search-input').value = '';
    document.getElementById('filter-form').submit();
}

// Remove filter function
function removeFilter(filterType, value) {
    const form = document.getElementById('filter-form');
    const inputs = form.querySelectorAll(`input[name="${filterType}"]`);
    inputs.forEach(input => {
        if (input.value === value) {
            input.checked = false;
        }
    });
    form.submit();
}

// Global function to handle sort change
function handleSortChange(selectElement) {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Update the sort parameter
    urlParams.set('sort', selectElement.value);
    urlParams.set('page', '1'); // Reset to first page when sorting
    
    // Navigate to the new URL
    window.location.href = '?' + urlParams.toString();
}

// Debounced search
function initializeDebouncedSearch() {
    const searchInput = document.getElementById('search-input');
    let timeoutId;
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                this.form.submit();
            }, 300);
        });
    }
}

// Fair Price Modal Functions
function openFairPriceModal(componentId) {
    const modal = document.getElementById('fairPriceModal');
    const nameElement = document.getElementById('componentName');
    const skuElement = document.getElementById('componentSku');
    const priceElement = document.getElementById('fairPrice');
    
    // Get data from hidden elements
    const name = document.getElementById(`component-${componentId}-name`).textContent;
    const sku = document.getElementById(`component-${componentId}-sku`).textContent;
    const fairPrice = document.getElementById(`component-${componentId}-fair-price`).textContent;
    const reasoning = document.getElementById(`component-${componentId}-reasoning`).textContent;
    const pros = document.getElementById(`component-${componentId}-pros`).textContent;
    const cons = document.getElementById(`component-${componentId}-cons`).textContent;
    const marketNotes = document.getElementById(`component-${componentId}-market-notes`).textContent;
    
    // Set component info
    nameElement.textContent = name;
    skuElement.textContent = sku ? `SKU: ${sku}` : '';
    
    // Set fair price
    if (fairPrice && !isNaN(parseFloat(fairPrice))) {
        const roundedPrice = Math.round(parseFloat(fairPrice));
        priceElement.textContent = `$${roundedPrice}`;
    } else {
        priceElement.textContent = 'Price analysis available';
    }
    
    // Show/hide and populate sections based on available data
    populateModalSection('reasoningSection', 'reasoning', reasoning);
    populateModalList('prosSection', 'prosList', pros ? pros.split('|||') : []);
    populateModalList('consSection', 'consList', cons ? cons.split('|||') : []);
    populateModalSection('marketNotesSection', 'marketNotes', marketNotes);
    
    // Show modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeFairPriceModal() {
    const modal = document.getElementById('fairPriceModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto'; // Restore scrolling
}

function populateModalSection(sectionId, elementId, data) {
    const section = document.getElementById(sectionId);
    const element = document.getElementById(elementId);
    
    if (data && data.trim()) {
        element.textContent = data;
        section.classList.remove('hidden');
    } else {
        section.classList.add('hidden');
    }
}

function populateModalList(sectionId, listId, data) {
    const section = document.getElementById(sectionId);
    const list = document.getElementById(listId);
    
    if (data && Array.isArray(data) && data.length > 0) {
        list.innerHTML = '';
        data.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            list.appendChild(li);
        });
        section.classList.remove('hidden');
    } else {
        section.classList.add('hidden');
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('fairPriceModal');
    if (event.target === modal) {
        closeFairPriceModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeFairPriceModal();
    }
});

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeCategoryFiltering();
    initializeCollapsibleSections();
    initializeDebouncedSearch();
});
    </script>
{% endblock %}
{% extends 'frontend/base.html' %}

{% block content %}
<div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Filters Sidebar -->
            <div class="lg:w-1/4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-md font-semibold text-gray-900 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                        </svg>
                        Filters
                    </h2>
                        {% if current_filters.search or current_filters.brand or current_filters.voltage or current_filters.platform or current_filters.category_level1 or current_filters.category_level2 or current_filters.category_level3 or current_filters.status %}
                            <a href="?" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                Clear All
                            </a>
                        {% endif %}
                    </div>
                    
                    <!-- Active Filter Chips -->
                    <div class="mb-4">
                        <div class="flex flex-wrap gap-1">
                            <!-- Brand Chips -->
                            {% for brand in brands %}
                                {% if brand.id|stringformat:"s" in selected_brand_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ brand.name }}
                                        <button type="button" onclick="removeFilter('brand', '{{ brand.id }}')" class="ml-1 text-blue-600 hover:text-blue-800" aria-label="Remove {{ brand.name }} filter">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            <!-- Voltage Chips -->
                            {% for voltage in voltages %}
                                {% if voltage.id|stringformat:"s" in selected_voltage_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ voltage.value }}V
                                        <button type="button" onclick="removeFilter('voltage', '{{ voltage.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            <!-- Platform Chips -->
                            {% for platform in platforms %}
                                {% if platform.id|stringformat:"s" in selected_platform_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ platform.name }}
                                        <button type="button" onclick="removeFilter('platform', '{{ platform.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            <!-- Status Chips -->
                            {% for status in statuses %}
                                {% if status.id|stringformat:"s" in selected_status_ids %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                        {{ status.name }}
                                        <button type="button" onclick="removeFilter('status', '{{ status.id }}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            
                            <!-- Category Chips -->
                            {% if current_filters.category_level1 %}
                                {% for category in level1_categories %}
                                    {% if category.id|stringformat:"s" == current_filters.category_level1 %}
                                        <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                            {{ category.name }}
                                            <button type="button" onclick="clearCategory('level1')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            
                            {% if current_filters.category_level2 %}
                                {% for category in level2_categories_with_parent %}
                                    {% if category.id|stringformat:"s" == current_filters.category_level2 %}
                                        <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                            {{ category.name }}
                                            <button type="button" onclick="clearCategory('level2')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            
                            {% if current_filters.category_level3 %}
                                {% for category in level3_categories_with_parent %}
                                    {% if category.id|stringformat:"s" == current_filters.category_level3 %}
                                        <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                            {{ category.name }}
                                            <button type="button" onclick="clearCategory('level3')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <form method="get" id="filterForm" class="space-y-4">
                        
                        <!-- Search -->
                        <div class="filter-section mb-2 bg-gray-50 p-2 rounded-lg">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                                <div class="relative">
                                    <input type="text" name="search" id="searchInput" value="{{ current_filters.search }}" 
                                           class="w-full px-3 py-2 pr-8 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           placeholder="Search products...">
                                    {% if current_filters.search %}
                                        <button type="button" id="clearSearch" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Category Filters -->
                        <div class="filter-section mb-6 bg-gray-50 p-4 rounded-lg">
                            <div class="space-y-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                    <select name="category_level1" id="category_level1" class="w-full px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">All Categories</option>
                                        {% for category in level1_categories %}
                                            <option value="{{ category.id }}" {% if current_filters.category_level1 == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div>
                                    <!--<label class="block text-sm font-medium text-gray-700 mb-1">Subcategory</label>-->
                                    <select name="category_level2" id="category_level2" class="w-full px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">All Subcategories</option>
                                        {% for category in level2_categories_with_parent %}
                                            <option value="{{ category.id }}" 
                                                    data-parent="{{ category.parent }}"
                                                    {% if current_filters.category_level2 == category.id|stringformat:"s" %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div>
                                    <!--<label class="block text-sm font-medium text-gray-700 mb-1">Product Type</label>-->
                                    <select name="category_level3" id="category_level3" class="w-full px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">All Product Types</option>
                                        {% for category in level3_categories_with_parent %}
                                            <option value="{{ category.id }}" 
                                                    data-parent="{{ category.parent }}"
                                                    {% if current_filters.category_level3 == category.id|stringformat:"s" %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Brand Filter -->
                        <div class="filter-section mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="filter-header w-full flex items-center justify-between text-left" onclick="toggleSection('brand')" 
                                    aria-expanded="false" aria-controls="brand-content" aria-labelledby="brand-header"
                                    onkeydown="handleFilterKeydown(event, 'brand')" tabindex="0">
                                <span id="brand-header" class="text-sm font-medium text-gray-700">
                                    Brand
                                    {% if filter_counts.brands.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.brands.selected }}/{{ filter_counts.brands.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="brand-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="brand-content" class="filter-content" role="region" aria-labelledby="brand-header">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2" role="group" aria-label="Brand filter options">
                                    {% for brand in brands %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer" for="brand_{{ brand.id }}">
                                            <input type="checkbox" name="brand" value="{{ brand.id }}" id="brand_{{ brand.id }}"
                                                   {% if brand.id|stringformat:"s" in selected_brand_ids %}checked{% endif %}
                                                   class="mr-2 text-blue-600 focus:ring-blue-500"
                                                   onchange="setTimeout(() => this.form.submit(), 10)"
                                                   aria-describedby="brand_{{ brand.id }}_desc">
                                            <span class="text-sm" id="brand_{{ brand.id }}_desc">{{ brand.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Voltage Filter -->
                        <div class="filter-section mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="filter-header w-full flex items-center justify-between text-left" onclick="toggleSection('voltage')" 
                                    aria-expanded="true" aria-controls="voltage-content" aria-labelledby="voltage-header"
                                    onkeydown="handleFilterKeydown(event, 'voltage')" tabindex="0">
                                <span id="voltage-header" class="text-sm font-medium text-gray-700">
                                    Voltage
                                    {% if filter_counts.voltages.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.voltages.selected }}/{{ filter_counts.voltages.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="voltage-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="voltage-content" class="filter-content">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2">
                                    {% for voltage in voltages %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer">
                                            <input type="checkbox" name="voltage" value="{{ voltage.id }}" 
                                                   {% if voltage.id|stringformat:"s" in selected_voltage_ids %}checked{% endif %}
                                                   class="mr-2 text-blue-600 focus:ring-blue-500"
                                                   onchange="setTimeout(() => this.form.submit(), 10)">
                                            <span class="text-sm">{{ voltage.value }}V</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Platform Filter -->
                        <div class="filter-section mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="filter-header w-full flex items-center justify-between text-left" onclick="toggleSection('platform')" 
                                    aria-expanded="true" aria-controls="platform-content" aria-labelledby="platform-header"
                                    onkeydown="handleFilterKeydown(event, 'platform')" tabindex="0">
                                <span id="platform-header" class="text-sm font-medium text-gray-700">
                                    Platform
                                    {% if filter_counts.platforms.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.platforms.selected }}/{{ filter_counts.platforms.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="platform-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="platform-content" class="filter-content">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2">
                                    {% for platform in platforms %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer">
                                            <input type="checkbox" name="platform" value="{{ platform.id }}" 
                                                   {% if platform.id|stringformat:"s" in selected_platform_ids %}checked{% endif %}
                                                   class="mr-2 text-blue-600 focus:ring-blue-500"
                                                   onchange="setTimeout(() => this.form.submit(), 10)">
                                            <span class="text-sm">{{ platform.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Status Filter -->
                        <div class="filter-section mb-6 bg-gray-50 p-4 rounded-lg">
                            <button type="button" class="filter-header w-full flex items-center justify-between text-left" onclick="toggleSection('status')" 
                                    aria-expanded="false" aria-controls="status-content" aria-labelledby="status-header"
                                    onkeydown="handleFilterKeydown(event, 'status')" tabindex="0">
                                <span id="status-header" class="text-sm font-medium text-gray-700">
                                    Status
                                    {% if filter_counts.statuses.selected > 0 %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ filter_counts.statuses.selected }}/{{ filter_counts.statuses.total }}
                                        </span>
                                    {% endif %}
                                </span>
                                <svg class="w-4 h-4 transform transition-transform" id="status-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="status-content" class="filter-content hidden">
                                <div class="max-h-32 overflow-y-auto border border-gray-200 rounded p-2">
                                    {% for status in statuses %}
                                        <label class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer">
                                            <input type="checkbox" name="status" value="{{ status.id }}" 
                                                   {% if status.id|stringformat:"s" in selected_status_ids %}checked{% endif %}
                                                   class="mr-2 text-blue-600 focus:ring-blue-500"
                                                   onchange="setTimeout(() => this.form.submit(), 10)">
                                            <span class="text-sm">{{ status.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>



                        <!-- Hidden inputs to preserve page parameter -->
                        <input type="hidden" name="page" value="1">
                        
                    </form>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="lg:w-3/4">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900" role="status" aria-live="polite">
                        {% if products %}
                            Showing {{ products.start_index }}-{{ products.end_index }} of {{ products.paginator.count }} products
                        {% else %}
                            No products found
                        {% endif %}
                    </h2>
                    
                    <!-- Sort Dropdown -->
                    <div class="flex items-center space-x-2">
                        <label for="sortSelect" class="text-sm font-medium text-gray-700">Sort by:</label>
                        <select id="sortSelect" name="sort" class="px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" onchange="handleSortChange(this)">
                            <option value="name" {% if current_filters.sort == 'name' %}selected{% endif %}>Name</option>
                            <option value="brand" {% if current_filters.sort == 'brand' %}selected{% endif %}>Brand</option>
                            <option value="voltage" {% if current_filters.sort == 'voltage' %}selected{% endif %}>Voltage</option>
                            <option value="release_date" {% if current_filters.sort == 'release_date' %}selected{% endif %}>Release Date</option>
                        </select>
                        <button type="button" id="sortDirectionToggle" class="p-1 text-gray-600 hover:text-gray-800 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded" onclick="toggleSortDirection()" title="Toggle sort direction">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                {% if current_filters.sort_direction == 'desc' %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                {% else %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                {% endif %}
                            </svg>
                        </button>
                    </div>
                </div>

                {% if products %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {% for product in products %}
                            <div class="bg-white rounded-xl shadow-sm border group flex flex-col">
                                <a href="{% url 'product_detail' product.id %}">
                                    <div class="aspect-square bg-white rounded-t-xl overflow-hidden">
                                        {% if product.image %}
                                            <img src="{{ product.image }}" alt="{{ product.name }}" class="w-full h-full object-contain p-2">
                                        {% else %}
                                            <div class="w-full h-full flex items-center justify-center text-gray-400">
                                                <div class="text-center">
                                                    <svg class="w-16 h-16 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    <p class="text-sm">No Image</p>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </a>
                                <div class="p-5 flex flex-col flex-grow">
                                    <div class="mb-3">
                                        <h3 class="font-semibold text-gray-900 line-clamp-2 leading-tight mb-2">{{ product.name }}</h3>
                                        {% if product.status.name != 'Active' %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                                {% if product.status.name == 'Discontinued' %}bg-red-100 text-red-800
                                                {% elif product.status.name == 'Pre-release' %}bg-yellow-100 text-yellow-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ product.status.name }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="space-y-2 mb-4">
                                        {% if product.brand %}
                                            <div class="text-sm">
                                                <span id="brand-{{ product.id }}" class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold" 
                                                      style="background-color: {{ product.brand.color|default:'#6b7280' }}; color: white;"
                                                      data-brand-color="{{ product.brand.color|default:'#6b7280' }}">
                                                    {{ product.brand.name }}
                                                </span>
                                            </div>
                                        {% endif %}
                                        {% if product.sku %}
                                            <div class="flex items-center text-sm text-gray-600">
                                                <span class="font-medium w-16">Model#:</span>
                                                <span class="font-medium">{{ product.sku }}</span>
                                            </div>
                                        {% endif %}
                                    </div>


                                    <div class="mt-auto">
                                        <a href="{% url 'product_detail' product.id %}" class="block w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg text-sm font-medium hover:bg-blue-700 text-center">
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if products.has_other_pages %}
                        <div class="mt-8 flex justify-between items-center">
                            <!-- Viewing info -->
                            <div class="text-sm text-gray-600">
                                Viewing <span class="font-semibold">{{ products.start_index }}-{{ products.end_index }}</span> of <span class="font-semibold">{{ products.paginator.count }}</span>
                            </div>
                            
                            <!-- Pagination controls -->
                            <nav class="flex items-center gap-2">
                                <!-- Previous arrow -->
                                {% if products.has_previous %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products.previous_page_number }}" 
                                       class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-xl">
                                        <
                                    </a>
                                {% else %}
                                    <span class="text-gray-300 text-xl"></span>
                                {% endif %}

                                <!-- Page numbers -->
                                {% for num in products.paginator.page_range %}
                                    {% if products.number == num %}
                                        <span class="font-semibold text-gray-900 border-b-2 border-orange-500 text-md">{{ num }}</span>
                                    {% elif num >= products.number|add:'-2' and num <= products.number|add:'2' or products.number <= 3 and num <= 5 %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                    {% elif num == 1 and products.number > 4 %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                        <span class="text-gray-400 text-sm">...</span>
                                    {% elif num == products.paginator.num_pages and products.number < products.paginator.num_pages|add:'-3' %}
                                        <span class="text-gray-400 text-sm">...</span>
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                                           class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-sm">
                                            {{ num }}
                                        </a>
                                    {% endif %}
                                {% endfor %}

                                <!-- Next arrow -->
                                {% if products.has_next %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products.next_page_number }}" 
                                       class="text-gray-500 hover:text-gray-900 transition-colors duration-200 text-xl">
                                        >
                                    </a>
                                {% else %}
                                    <span class="text-gray-300 text-xl"></span>
                                {% endif %}

                            </nav>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
                        <p class="text-gray-500">Try adjusting your filters or search terms.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
    // Function to calculate luminance and determine appropriate text color
    function calculateTextColor(hexColor) {
        // Remove # if present
        hexColor = hexColor.replace('#', '');
        
        // Parse hex to RGB
        const r = parseInt(hexColor.substr(0, 2), 16);
        const g = parseInt(hexColor.substr(2, 2), 16);
        const b = parseInt(hexColor.substr(4, 2), 16);
        
        // Calculate relative luminance using WCAG formula
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        
        // Return white for dark backgrounds, black for light backgrounds
        return luminance < 0.5 ? 'white' : 'black';
    }
    
    // Function to apply brand color styling
    function applyBrandColorStyling() {
        document.querySelectorAll('[data-brand-color]').forEach(element => {
            const brandColor = element.getAttribute('data-brand-color');
            if (brandColor) {
                const textColor = calculateTextColor(brandColor);
                element.style.color = textColor;
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Apply brand color styling
        applyBrandColorStyling();
        
        // Initialize collapsible sections
        initializeCollapsibleSections();
        
        
        // Initialize debounced search
        initializeDebouncedSearch();
        
        const form = document.getElementById('filterForm');
        const level1 = document.querySelector('[name="category_level1"]');
        const level2 = document.querySelector('[name="category_level2"]');
        const level3 = document.querySelector('[name="category_level3"]');
        
        // Auto-submit category dropdowns
        level1.addEventListener('change', function() {
            // Clear child selections when parent changes
            level2.value = '';
            level3.value = '';
            // Add hidden inputs to preserve other filters
            preserveOtherFilters();
            form.submit();
        });
        
        level2.addEventListener('change', function() {
            // Clear child selection when parent changes
            level3.value = '';
            preserveOtherFilters();
            form.submit();
        });
        
        level3.addEventListener('change', function() {
            preserveOtherFilters();
            form.submit();
        });
        
        // Function to preserve other filter values during category changes
        function preserveOtherFilters() {
            // Get all current filter values from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const search = urlParams.get('search') || '';
            const sort = urlParams.get('sort') || 'name';
            
            // Update form inputs (only single-value inputs)
            document.querySelector('[name="search"]').value = search;
            document.querySelector('[name="sort"]').value = sort;
            
            // Note: Multi-select filters (brand, voltage, platform, status) 
            // are handled by the server-side template rendering and don't need JavaScript updates
        }
        
        // Multi-select filter functionality
        const filterTypes = ['brand', 'voltage', 'platform', 'status'];
        
        filterTypes.forEach(filterType => {
            const checkboxes = document.querySelectorAll(`input[name="${filterType}"]`);
            
            // Handle checkbox changes
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const autoSubmit = document.getElementById('autoSubmitToggle').checked;
                    if (autoSubmit) {
                        form.submit();
                    } else {
                        // Show apply button when auto-submit is disabled
                        document.getElementById('applyFiltersButton').classList.remove('hidden');
                    }
                });
            });
        });
        
        function updateChips(filterType) {
            const chipsContainer = document.getElementById(`${filterType}-chips`);
            const checkboxes = document.querySelectorAll(`input[name="${filterType}"]:checked`);
            
            // Clear existing chips
            chipsContainer.innerHTML = '';
            
            // Add chips for checked items
            checkboxes.forEach(checkbox => {
                const label = checkbox.parentElement.querySelector('span').textContent;
                const chip = document.createElement('span');
                chip.className = 'inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full';
                chip.innerHTML = `${label} <button type="button" onclick="removeFilter('${filterType}', '${checkbox.value}')" class="ml-1 text-blue-600 hover:text-blue-800">×</button>`;
                chipsContainer.appendChild(chip);
            });
        }
        
        // Initialize chips on page load - chips are already rendered from backend
        // Server-rendered chips are already visible, no JavaScript needed
    });
    
    // Global function to remove filter chips
    function removeFilter(filterType, value) {
        const checkbox = document.querySelector(`input[name="${filterType}"][value="${value}"]`);
        if (checkbox) {
            checkbox.checked = false;
            // Submit form to update the page with new filter state
            document.getElementById('filterForm').submit();
        }
    }
    
    // Global function to clear category selections
    function clearCategory(level) {
        if (level === 'level1') {
            document.querySelector('[name="category_level1"]').value = '';
            document.querySelector('[name="category_level2"]').value = '';
            document.querySelector('[name="category_level3"]').value = '';
        } else if (level === 'level2') {
            document.querySelector('[name="category_level2"]').value = '';
            document.querySelector('[name="category_level3"]').value = '';
        } else if (level === 'level3') {
            document.querySelector('[name="category_level3"]').value = '';
        }
        document.getElementById('filterForm').submit();
    }
    
    // Global function to handle sort change
    function handleSortChange(selectElement) {
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // Update the sort parameter
        urlParams.set('sort', selectElement.value);
        urlParams.set('page', '1'); // Reset to first page when sorting
        
        // Preserve sort_direction parameter
        const currentDirection = urlParams.get('sort_direction') || 'asc';
        urlParams.set('sort_direction', currentDirection);
        
        // Navigate to the new URL
        window.location.href = '?' + urlParams.toString();
    }
    
    // Global function to toggle sort direction
    function toggleSortDirection() {
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // Toggle the sort direction
        const currentDirection = urlParams.get('sort_direction') || 'asc';
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        
        // Update the sort direction parameter
        urlParams.set('sort_direction', newDirection);
        urlParams.set('page', '1'); // Reset to first page when changing direction
        
        // Navigate to the new URL
        window.location.href = '?' + urlParams.toString();
    }
    
    // updateChips function removed - chips are server-rendered
    
    
    
    // Debounced search functionality
    function initializeDebouncedSearch() {
        const searchInput = document.getElementById('searchInput');
        const clearButton = document.getElementById('clearSearch');
        let searchTimeout;
        
        // Debounced search with 300ms delay
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const autoSubmit = document.getElementById('autoSubmitToggle').checked;
                if (autoSubmit) {
                    this.form.submit();
                } else {
                    // Show apply button when auto-submit is disabled
                    document.getElementById('applyFiltersButton').classList.remove('hidden');
                }
            }, 300);
        });
        
        // Clear search functionality
        if (clearButton) {
            clearButton.addEventListener('click', function() {
                searchInput.value = '';
                searchInput.focus();
                const autoSubmit = document.getElementById('autoSubmitToggle').checked;
                if (autoSubmit) {
                    searchInput.form.submit();
                } else {
                    document.getElementById('applyFiltersButton').classList.remove('hidden');
                }
            });
        }
        
        // Show/hide clear button based on input value
        searchInput.addEventListener('input', function() {
            const clearBtn = document.getElementById('clearSearch');
            if (this.value.trim()) {
                if (!clearBtn) {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.id = 'clearSearch';
                    button.className = 'absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600';
                    button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                    button.addEventListener('click', function() {
                        searchInput.value = '';
                        searchInput.focus();
                        const autoSubmit = document.getElementById('autoSubmitToggle').checked;
                        if (autoSubmit) {
                            searchInput.form.submit();
                        } else {
                            document.getElementById('applyFiltersButton').classList.remove('hidden');
                        }
                    });
                    searchInput.parentElement.appendChild(button);
                }
            } else if (clearBtn) {
                clearBtn.remove();
            }
        });
    }
    
    // Keyboard navigation functionality
    function handleFilterKeydown(event, sectionId) {
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            toggleSection(sectionId);
        }
    }
    
    // Collapsible sections functionality
    function initializeCollapsibleSections() {
        // Initialize all sections as expanded by default
        document.querySelectorAll('.filter-section').forEach(section => {
            const header = section.querySelector('.filter-header');
            const content = section.querySelector('.filter-content');
            const chevron = section.querySelector('svg');
            
            if (header && content && chevron) {
                const sectionId = header.getAttribute('onclick').match(/toggleSection\('([^']+)'\)/)[1];
                
                // Set sections based on their initial state
                if (content.classList.contains('hidden')) {
                    // Section is collapsed by default
                    chevron.style.transform = 'rotate(-90deg)';
                    header.setAttribute('aria-expanded', 'false');
                } else {
                    // Section is expanded by default
                    content.classList.remove('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                    header.setAttribute('aria-expanded', 'true');
                }
                
                header.addEventListener('click', function() {
                    toggleSection(sectionId);
                });
            }
        });
    }
    
    function toggleSection(sectionId) {
        const content = document.getElementById(sectionId + '-content');
        const chevron = document.getElementById(sectionId + '-chevron');
        const button = document.querySelector(`[aria-controls="${sectionId}-content"]`);
        
        if (content && chevron && button) {
            const isExpanded = !content.classList.contains('hidden');
            
            if (isExpanded) {
                // Collapse the section
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(-90deg)';
                button.setAttribute('aria-expanded', 'false');
            } else {
                // Expand the section
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(0deg)';
                button.setAttribute('aria-expanded', 'true');
            }
        }
    }
    
    // Category hierarchy filtering
    function initializeCategoryFiltering() {
        const categoryLevel1 = document.getElementById('category_level1');
        const categoryLevel2 = document.getElementById('category_level2');
        const categoryLevel3 = document.getElementById('category_level3');
        
        if (categoryLevel1 && categoryLevel2 && categoryLevel3) {
            // Filter level 2 options based on level 1 selection
            categoryLevel1.addEventListener('change', function() {
                const selectedLevel1 = this.value;
                const level2Options = categoryLevel2.querySelectorAll('option[data-parent]');
                
                level2Options.forEach(option => {
                    if (selectedLevel1 === '' || option.dataset.parent === selectedLevel1) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
                
                // Reset level 2 and 3 selections if parent changed
                if (categoryLevel2.value && categoryLevel2.querySelector(`option[value="${categoryLevel2.value}"][data-parent="${selectedLevel1}"]`)) {
                    // Keep current selection if it's still valid
                } else {
                    categoryLevel2.value = '';
                    categoryLevel3.value = '';
                }
                
                // Filter level 3 options
                filterLevel3Options();
                
                // Auto-submit form when category changes
                setTimeout(() => this.form.submit(), 10);
            });
            
            // Filter level 3 options based on level 2 selection
            categoryLevel2.addEventListener('change', function() {
                filterLevel3Options();
                
                // Auto-submit form when subcategory changes
                setTimeout(() => this.form.submit(), 10);
            });
            
            // Auto-submit form when product type changes
            categoryLevel3.addEventListener('change', function() {
                setTimeout(() => this.form.submit(), 10);
            });
            
            function filterLevel3Options() {
                const selectedLevel2 = categoryLevel2.value;
                const level3Options = categoryLevel3.querySelectorAll('option[data-parent]');
                
                level3Options.forEach(option => {
                    if (selectedLevel2 === '' || option.dataset.parent === selectedLevel2) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
                
                // Reset level 3 selection if parent changed
                if (categoryLevel3.value && categoryLevel3.querySelector(`option[value="${categoryLevel3.value}"][data-parent="${selectedLevel2}"]`)) {
                    // Keep current selection if it's still valid
                } else {
                    categoryLevel3.value = '';
                }
            }
            
            // Initialize filtering on page load without triggering events
            const selectedLevel1 = categoryLevel1.value;
            const level2Options = categoryLevel2.querySelectorAll('option[data-parent]');
            
            level2Options.forEach(option => {
                if (selectedLevel1 === '' || option.dataset.parent === selectedLevel1) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Filter level 3 options
            const selectedLevel2 = categoryLevel2.value;
            const level3Options = categoryLevel3.querySelectorAll('option[data-parent]');
            
            level3Options.forEach(option => {
                if (selectedLevel2 === '' || option.dataset.parent === selectedLevel2) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
    }
    
    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeDebouncedSearch();
        initializeCollapsibleSections();
        initializeCategoryFiltering();
        
        // Debug: Log that initialization is complete
        console.log('Filter UI initialized');
    });
    </script>
{% endblock %}
